<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sysevent_script_action">
    <sysevent_script_action action="INSERT_OR_UPDATE">
        <active>true</active>
        <condition_script/>
        <description/>
        <event_name>x_ibmrt_gdpva.ReconcileUnmatched</event_name>
        <name>EventHandler_ReconcileUnmatched</name>
        <order>100</order>
        <script><![CDATA[var EventHandler_ReconcileUnmatched = Class.create();

EventHandler_ReconcileUnmatched.prototype = {
    initialize: function(integ_sys_id) {
        this.integ_sys_id = integ_sys_id;
    },

    cleanUp: function() {
        if (!this.integ_sys_id) throw new Error('Integration sys_id cannot be empty');

        // find unmatched
        var unmatchedCI = [];
        var gr_disc_item = new GlideRecord('sn_sec_cmn_src_ci');
        gr_disc_item.addQuery('source', '=', integ_sys_id);
        gr_disc_item.query();
        while (gr_disc_item.next()) {
            if (!gr_disc_item.getValue('ci_lookup_rule') ||
                'unmatched' == this.getDiscoveredItemState(gr_disc_item.getValue('cmdb_ci'))
            ) {
                unmatchedCI.push(gr_disc_item.getUniqueValue());
                if ('matched' == gr_disc_item.getValue('state')) {
                    // initial state is wrong, update it
                    gr_disc_item.setValue('state', 'unmatched');
                    gr_disc_item.update();
                }
            }
        }
    },

    run: function() {
        if (!this.integ_sys_id) throw new Error('Integration sys_id cannot be empty');

        // if there are unmatched DIs, then run the reconcile process
        var message = '';
        var util = new sn_sec_cmn.BackgroundJobUtils();
        var url = util.getRunningJobUrl('Reconcile unmatched discovered items');
        if (url)
            message = 'CI Lookup rules are currently being rerun on the selected discovered items.' +
            ' You can rerun the rules after this process is complete.';
        else if (!new sn_sec_cmn.CILookupUtil().canExecuteBackgroundJob())
            message = 'An integration run or proof granularity job is in progress.' +
            ' You can create a new job after it is complete.';
        else {
            var params = {
                src_ci_sys_ids: unmatchedCI
            };
            var job = util.createBackgroundJob(
                'sn_sec_cmn_src_ci',
                'Reconcile unmatched discovered items',
                JSON.stringify(params),
                "", "",
                "sn_sec_cmn.reconcile_unmatched_discovered_items"
            );
            message = 'Applying CI lookup rules to unmatched IBM Guardium database entries';
        }
        GuardiumLog.info(message, this.type);
    },

    getDiscoveredItemState: function(ci_sys_id) {
        var gr_ci = new GlideRecord('cmdb_ci');
        if (gr_ci.get(ci_sys_id)) {
            GuardiumLog.debug(gr_ci.getDisplayValue() + " : " +
                gr_ci.getTableName() + " : " + gr_ci.getRecordClassName(), this.type);
            return 'sn_sec_cmn_src_ci' == gr_ci.get.getTableName() ||
                'sn_sec_cmn_src_ci' == gr_ci.getRecordClassName() ? 'unmatched' : 'matched';
        }
        return 'unmatched';
    },

    type: 'EventHandler_ReconcileUnmatched'
};

(function executeEventHandler(event, current) {
    var eventHandler = new EventHandler_ReconcileUnmatched(event.parm1);
    try {
        eventHandler.cleanUp();
    } catch (e) {
        GuardiumLog.error('Clean Up', eventHandler.type, e);
    }
    try {
        eventHandler.run();
    } catch (e) {
        GuardiumLog.error('Reconcile', eventHandler.type, e);
    }

})(event, current);]]></script>
        <synchronous>false</synchronous>
        <sys_class_name>sysevent_script_action</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-01-24 20:51:51</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>4d06eeda97ec6d10b0ed79100153afcf</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>EventHandler_ReconcileUnmatched</sys_name>
        <sys_overrides/>
        <sys_package display_value="IBM Guardium Data Protection" source="x_ibmrt_gdpva">400d30552fa0111049572f2ef699b65a</sys_package>
        <sys_policy/>
        <sys_scope display_value="IBM Guardium Data Protection">400d30552fa0111049572f2ef699b65a</sys_scope>
        <sys_update_name>sysevent_script_action_4d06eeda97ec6d10b0ed79100153afcf</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-02-11 15:08:58</sys_updated_on>
    </sysevent_script_action>
</record_update>
