<?xml version="1.0" encoding="UTF-8"?>
<record_update sys_domain="global" table="sn_sec_cmn_ci_lookup_rule">
<sn_sec_cmn_ci_lookup_rule action="INSERT_OR_UPDATE">
<active>true</active>
<condition/>
<description>IBM Guardium data is added to the source_data field of a Discovered Item as JSON.  This JSON can be used to match with Database Instance and Database Catalog entries.</description>
<lookup_script display_value=""/>
<method>script</method>
<name>IBM Guardium Lookup Rule</name>
<order>216</order>
<reapply>false</reapply>
<reapply_version>0</reapply_version>
<script><![CDATA[var IBMGuardiumCILookupRule = Class.create();

IBMGuardiumCILookupRule.prototype = {
    initialize: function(sourceValue, sourcePayload) {
        // Ensure JSON data
        try {
            if (!sourcePayload) sourcePayload = sourceValue;
            if ("string" == typeof(sourcePayload)) sourcePayload = JSON.parse(sourceValue);
            this.payload = sourcePayload;
        } catch (e) {
            var errMsg = 'Unable to parse Discovered Item payload.';
            x_ibmrt_gdpva.GuardiumLog.error(errMsg, this.type, sourceValue);
            gs.error(errMsg, sourceValue);
            return null;
        }
    },

    initializeGr: function(table_name, default_table_name) {
        var gr = null;
        try {
            gr = new GlideRecord(table_name);
        } catch (e) {
            errMsg = 'Unable to use table: ' + table_name;
            x_ibmrt_gdpva.GuardiumLog.error(errMsg, this.type, e);
            gs.error(errMsg, e);
            if (default_table_name) {
                try {
                    table_name = default_table_name;
                    gri = new GlideRecord(table_name);
                } catch (e1) {
                    errMsg = 'Unable to use table: ' + table_name;
                    x_ibmrt_gdpva.GuardiumLog.error(errMsg, this.type, e1);
                    gs.error(errMsg, e1);
                }
            }
        }
        return gr;
    },

    getDatabaseInstanceTransformMap: function(dbType) {
        var gr_map = new GlideRecord('x_ibmrt_gdpva_db_instance_transform_map');
        gr_map.addQuery('database_type', '=', dbType);
        gr_map.setLimit(1);
        gr_map.query();
        if (gr_map.next) {
            return {
                database_instance_class: gr_map.getValue('database_instance_class'),
                database_name: gr_map.getValue('database_name'),
                service_name: gr_map.getValue('service_name'),
                tcp_port: gr_map.getValue('tcp_port')
            };
        }
        return {};
    },

    findMatchingCatalog: function(di_sys_id, database_name) {
        if (database_name) {
            var gr_dc = this.initializeGr('cmdb_ci_db_catalog');
            if (gr_dc) {
                gr_dc.addQuery('database_instance', '=', di_sys_id);
                gr_dc.addQuery('name', '=', database_name);
                gr_dc.setLimit(1);
                gr_dc.query();
                if (gr_dc.next()) {
                    return gr_dc;
                }
            }
        }
        return null;
    },

    runRule: function() {
        if (!this.payload) {
            x_ibmrt_gdpva.GuardiumLog.error('Payload is empty. Exiting.', this.type);
            return null;
        }

        // Get configurable properties
        var transformMap = this.getDatabaseInstanceTransformMap(this.payload['datasource_type']);

        // Find matching Database Instance 
        var gr_di = this.initializeGr(
            this.payload['database_instance_class'] || transformMap['database_instance_class'], 'cmdb_ci_db_instance'
        );

        // Build query
        var asQuery = ["table=" + gr_di.getClassDisplayValue()];

        // Add FQDN to query
        asQuery.push('fqdn=' + this.payload['fqdn']);
        gr_di.addQuery('fqdn', '=', this.payload['fqdn']);

        // Add PORT to query
        asQuery.push('tcp_port=' + this.payload['tcp_port'] || transformMap['tcp_port']);
        gr_di.addQuery('tcp_port', '=', this.payload['tcp_port'] || transformMap['tcp_port']);

        // Add optional service_name
        if (transformMap['service_name']) {
            asQuery.push(transformMap['service_name'] + '=' + this.payload['service_name']);
            gr_di.addQuery(transformMap['service_name'], '=', this.payload['service_name']);
        }

        // Add database_name to log only
        if (transformMap['database_name']) {
            asQuery.push(transformMap['database_name'] + this.payload['database_name']);
        }

        // Log query
        x_ibmrt_gdpva.GuardiumLog.debug('Lookup query:\n' + asQuery.join(', '), this.type);
        gr_di.query();

        while (gr_di.next()) {
            // if db instance matches, return it
            if (this.payload['database_name'] && this.payload['database_name'] == gr_di.getValue(transformMap['database_name'])) {
                // Found matching db instance!
                x_ibmrt_gdpva.GuardiumLog.debug(
                    'Found matching Database Instance: ' + gr_di.getDisplayValue(gr_di.getDisplayName()), this.type
                );
                return gr_di.getUniqueValue();
            }
            // else try to match db catalog
            var gr_dc = this.findMatchingCatalog(gr_di.getUniqueValue(), this.payload['database_name']);
            if (gr_dc) {
                // Found matching db catalog!
                x_ibmrt_gdpva.GuardiumLog.debug(
                    'Found matching Database Catalog: ' + gr_dc.getDisplayValue(gr_dc.getDisplayName()), this.type
                );
                return gr_dc.getUniqueValue();
            }
        }

        x_ibmrt_gdpva.GuardiumLog.debug('No match for:\n' + asQuery.join(', '), this.type);
        return null;
    },
    type: 'IBMGuardiumCILookupRule'
};

(function process(rule, sourceValue, sourcePayload) {
    /*********************************
     * CI Lookup Rule Script
     * 
     * Available variables:
     * - rule:          Reference to the lookup rule that is being evaluated
     * - sourceValue:   The value of the source field from incoming data that is used for lookup
     * - sourcePayload: All the fields from incoming data that can be used for matching CI 
     *
     * Return either:
     * - the sysid of the CI that was matched by the rule
     * - null if there were no CI records that matched
     **********************************/

    new IBMGuardiumCILookupRule(sourceValue, sourcePayload).runRule();

})(rule, sourceValue, sourcePayload);]]></script>
<source display_value="IBM Guardium Integration">24f0f5c687744d10387c64280cbb350c</source>
<source_field>source_data</source_field>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2022-09-28 13:43:30</sys_created_on>
<sys_domain>global</sys_domain>
<sys_domain_path>/</sys_domain_path>
<sys_id>4919d5989792155022fa1c800153af56</sys_id>
<sys_mod_count>1</sys_mod_count>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2022-10-10 18:10:13</sys_updated_on>
<table/>
<target_field/>
<target_table/>
<type>custom</type>
</sn_sec_cmn_ci_lookup_rule>
</record_update>
