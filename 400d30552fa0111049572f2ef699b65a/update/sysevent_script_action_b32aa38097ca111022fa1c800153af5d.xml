<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sysevent_script_action">
    <sysevent_script_action action="INSERT_OR_UPDATE">
        <active>true</active>
        <condition_script/>
        <description/>
        <event_name>x_ibmrt_gdpva.QueueDataExport</event_name>
        <name>EventHandler_QueueDataExport</name>
        <order>218</order>
        <script><![CDATA[(function executeEventHandler(event, current) {
    if (!event) return;
	var this_type = 'EventHandler_QueueDataExport';
	
    var cm_name = 'Synchronize ' + (event.parm1 || 'IBM Guardium Central Manager');
    var cm_sys_id = (event.parm2 || '');
    if (!current) {
        current = new GlideRecord(GuardiumAPI.TABLE_CM);
        if (!current.get(cm_sys_id)) {
            GuardiumLog.error('Invalid central manager: ' + cm_name, this_type);
            return;
        }
    }

    // Find all DB, DB Group, and Test Exc, with Export or Delete action
    //  then attempt to perform that action

    // ** Test Exceptions **
    var gr_te = new GlideRecord(GuardiumAPI.TABLE_TE);
    gr_te.addQuery('action', '!=', 'synchronized');
    gr_te.query();
    while (gr_te.next()) {
		var te_action = gr_te.getValue('action');
        var te_name = gr_te.getDisplayValue(gr_te.getDisplayName());
        try {
            switch (te_action) {
                case 'export':
                    new GuardiumExportTestException().runOnce(gr_te, cm_sys_id);
                    GuardiumLog.info("Exported test exception: " + te_name, this_type);
                    break;

                case 'delete':
                    new GuardiumExportTestException().runOnce(gr_te, cm_sys_id, gr_te.getValue('id') || '0');
                    GuardiumLog.info("Deleted test exception: " + te_name, this_type);
                    break;
            }

        } catch (errTE) {
            GuardiumLog.error('', this_type, errTE);
        }
    }

	// ** Data Source Groups **
    var gr_grp = new GlideRecord(GuardiumAPI.TABLE_GRP);
    gr_grp.addQuery('action', '!=', 'synchronized');
    gr_grp.query();
    while (gr_grp.next()) {
		var grp_action = gr_grp.getValue('action');
        var grp_name = gr_grp.getDisplayValue(gr_grp.getDisplayName());
        try {
            switch (grp_action) {
                case 'export':
                    new GuardiumExportDatasourceGroup().runOnce(gr_grp, cm_sys_id);
                    GuardiumLog.info("Exported group: " + grp_name, this_type);
                    break;

                case 'delete':
                    new GuardiumExportDatasourceGroup().runOnce(gr_grp, cm_sys_id, gr_grp.getUniqueValue());
                    GuardiumLog.info("Deleted group: " + grp_name, this_type);
                    break;
            }
        } catch (errGrp) {
            GuardiumLog.error('', this_type, errGrp);
        }
    }

    // ** Data Sources **
    var gr_ds = new GlideRecord(GuardiumAPI.TABLE_DB_GDP);
    gr_ds.addQuery('action', '!=', 'synchronized');
    gr_ds.query();
    while (gr_ds.next()) {
		var ds_action = gr_ds.getValue('action');
        var ds_name = gr_ds.getDisplayValue(gr_ds.getDisplayName());
        try {
            switch (ds_action) {
                case 'export':
                    new GuardiumExportDatasource().process(gr_ds, cm_sys_id, false);
                    GuardiumLog.info("Exported data source: " + ds_name, this_type);
                    break;

                case 'delete':
                    new GuardiumExportDatasource().process(gr_ds, cm_sys_id, true);
                    GuardiumLog.info("Deleted data source: " + ds_name, this_type);
                    break;
            }
        } catch (errDs) {
            GuardiumLog.error('', this_type, errDs);
        }
    }

})(event, current);]]></script>
        <synchronous>false</synchronous>
        <sys_class_name>sysevent_script_action</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-09-15 19:40:01</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>b32aa38097ca111022fa1c800153af5d</sys_id>
        <sys_mod_count>12</sys_mod_count>
        <sys_name>EventHandler_QueueDataExport</sys_name>
        <sys_overrides/>
        <sys_package display_value="IBM Guardium Data Protection" source="x_ibmrt_gdpva">400d30552fa0111049572f2ef699b65a</sys_package>
        <sys_policy/>
        <sys_scope display_value="IBM Guardium Data Protection">400d30552fa0111049572f2ef699b65a</sys_scope>
        <sys_update_name>sysevent_script_action_b32aa38097ca111022fa1c800153af5d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2022-11-02 14:22:10</sys_updated_on>
    </sysevent_script_action>
</record_update>
