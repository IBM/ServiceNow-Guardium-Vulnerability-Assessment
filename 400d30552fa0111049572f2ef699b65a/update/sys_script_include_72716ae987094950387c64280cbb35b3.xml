<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_ibmrt_gdpva.GuardiumProcessorVulnerabilityTest</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>IBM Guardium processor script for adding third party vulnerability entries</description>
        <name>GuardiumProcessorVulnerabilityTest</name>
        <script><![CDATA[var GuardiumProcessorVulnerabilityTest = Class.create();

GuardiumProcessorVulnerabilityTest.VUL_ENTRY_FIELDS = {
    id: true,
    category: true,
    //classification: true,
    name: true,
    normalized_severity: true,
    source_severity: true,
    stig_severity: true,
    product: true,
    summary: true,
    source: true,
    source_instance: true,
	date_published: true,
	last_modified: true,
	access_vector: true,
	score: true
};
GuardiumProcessorVulnerabilityTest.CVE_REG_EX = /[CEVW]+-[0-9]+-?[0-9]*/g;

GuardiumProcessorVulnerabilityTest.prototype =
    Object.extendsObject(GuardiumProcessorBase, {

        beforeProcessReport: function(reportData) {
            this.sn_vul_tpv = new sn_vul.ThirdPartyVulnerability(
                GuardiumAPI.TITLE,
                this.integrationGr.sys_id,
                this.integrationRunGr.sys_id
            );

            try {
                this.sn_vulc_ct = new sn_vulc.ComplianceTest(GuardiumAPI.TITLE);
            } catch (er) {}

            this.failed_types = ',' + (this.preferences.getValue('test_failure_type') || '') + ',';
        },

        beforeCM: function(cm, data) {
            this.gAPI = new GuardiumAPI(GuardiumAPI.getGlideRecordCM(cm.sys_id, true));
            //this.gAPI.authenticate();
        },

        processEntry: function(datum, cm) {
			this.createOrUpdateDefinition(datum);
			
            //- Add or update Compliance Test -//
            var ct_rec = this.transformCT(datum);
            if (ct_rec) {
                // create compliance test
                var ct_entry = this.sn_vulc_ct.createOrUpdateTest(ct_rec);
				if (ct_entry.inserted) {
					this.inserted_cc++;
				} else
				if (ct_entry.updated) {
					this.updated_cc++;
				} else {
					this.skipped_cc++;
				}
                return ct_entry.sys_id;
            }

            //- Add or update Third Party Vulnerability Test -//
            var vt_rec = this.transformVT(datum);
            if (vt_rec) {

                // let script library find duplicate
                var vt_entry = this.sn_vul_tpv.createOrUpdateVulnerability(vt_rec);

                // if nothing created or updated, then create manually
                var sn_rec = new GlideRecord('sn_vul_third_party_entry');
                if (!vt_entry.sys_id) {
                    sn_rec.initialize();
                } else {
                    if (!sn_rec.get(vt_entry.sys_id)) {
						this.skipped_vi++;
						return vt_entry.sys_id;
					}
                }

                // Ensure fields are set!!
                for (var p in GuardiumProcessorVulnerabilityTest.VUL_ENTRY_FIELDS) {
                    sn_rec.setValue(p, vt_rec[p]);
                }

                // Insert or Update
                if (vt_entry.insert || !vt_entry.sys_id) {
                    vt_entry.sys_id = sn_rec.insert();
                    this.inserted_vi++;
                } else {
                    vt_entry.sys_id = sn_rec.update();
                    this.updated_vi++;
                }

				// Make sure ref data is called
				try {
					this.sn_vul_tpv._handleReferenceData(vt_entry.sys_id, vt_entry.id, vt_rec.referenceData);
				} catch (e) {}

				return vt_entry.sys_id;
            }
            return '';
        },

		createOrUpdateDefinition: function(datum) {
			var exists = false;
			var testID = (datum['Test Description'] || '').substring(0,2000);

			var gr = new GlideRecord('x_ibmrt_gdpva_test_definition');
			gr.addQuery('test_description', '=', testID);
			gr.query();
			gr.setLimit(1);
			if (gr.next()) {
				exists = true;
			}
			gr.setValue('test_description', testID);
			gr.setValue('description', (datum['Short Description'] || '').substring(0,2000));
			gr.setValue('test_type', (datum['Test Type'] || '').substring(0,255));
			gr.setValue('datasource_type', datum['Datasource Type'] || 'DB2');
			var test_date = this.gAPI.adjustTimeFromGuardium(datum['Timestamp']);
			gr.setValue('timestamp', test_date);
			
			if (!exists) {
				return gr.insert();
			} else {
				return gr.update();
			}
		},
	
        transformCT: function(datum) {
            // create test def if compliance is installed and this is not CVE
            if (this.sn_vulc_ct && this.failed_types.indexOf(',' + datum['Test Type'] + ',') < 0) {
                var test_date = this.gAPI.adjustTimeFromGuardium(datum['Timestamp']);
                var test_id = datum['Test Description'] ||
                    datum["External Reference"] ||
                    datum["STIG Reference"] ||
                    'Guardium Test ' + datum['Test ID'];

                var rec = this.sn_vulc_ct.newTest(test_id);
                rec.source = GuardiumAPI.TITLE;
                rec.source_id = datum['Test ID'] || '';
                rec.source_category = this.getLabel(datum['Category Name']);
                rec.source_sub_category = this.getLabel(datum['Test Type']);
                rec.short_description = test_id.substring(0, 512);
                rec.description = datum['Short Description'];
                rec.source_criticality = this.getLabel(datum['Severity']);
                rec.source_created = test_date;
                rec.source_udpated = this.dt_now;

                return rec;
            }
            return null;
        },

        transformVT: function(datum) {
            // DO NOT create test def if compliance is installed and this is not CVE
            if (this.sn_vulc_ct && this.failed_types.indexOf(',' + datum['Test Type'] + ',') < 0) {
                return null;
            }
            var test_date = this.gAPI.adjustTimeFromGuardium(datum['Timestamp']);
            var test_id = datum['Test Description'] ||
                datum["External Reference"] ||
                datum["STIG Reference"] ||
                'Guardium Test ' + datum['Test ID'];

            var rec = this.sn_vul_tpv.newVulnerability(test_id.substring(0, 255)); // limit ID to 255 chars
            rec.category = [this.getLabel(datum['Category Name']), 
							this.getLabel(datum['Test Type'])].join(' | ');
            //rec.classification = [datum['Category Name'] || '', datum['Test Type'] || ''].join('|');
            rec.name = test_id;
            rec.normalized_severity = rec.source_severity = this.convertSeverity(datum['Severity']);
            rec.stig_severity = this.getLabel(datum['STIG Severity']);
            rec.product = datum['Datasource Type'];
            rec.summary = datum['Short Description'];
            rec.source = GuardiumAPI.TITLE;
            rec.source_instance = this.integrationGr.sys_id;
            rec.date_published = test_date;
            rec.last_modified = this.dt_now;
            rec.access_vector = datum['CVSS Access Vector'] || ''; // v2 vector
            rec.score = (datum['CVSS Score'] || '0') - 0; // v2 score: convert to number

            if (!rec.cves) rec.cves = [];
			if (!rec.referenceData) rec.referenceData = [];

            var extRef = datum["External Reference"] ||
                datum["STIG Reference"] || datum['Test Description'] || '';

            // Find all references to CVE and CWE
            var keys = [];
            var match;
            if (extRef.indexOf('CVE-') >= 0 || extRef.indexOf('CWE-') >= 0) {
                match = extRef.match(GuardiumProcessorVulnerabilityTest.CVE_REG_EX);
                if (match.length > 0) {
                    keys = keys.concat(match);
                }
            }
            if (rec.summary.indexOf('CVE-') >= 0 || rec.summary.indexOf('CWE-') >= 0) {
                match = rec.summary.match(GuardiumProcessorVulnerabilityTest.CVE_REG_EX);
                if (match.length > 0) {
                    keys = keys.concat(match);
                }
            }
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                if (key.startsWith('CVE')) {
                    rec.cves.push({
                        id: key,
                        url: 'https://nvd.nist.gov/vuln/detail/' + key,
                    });
					rec.referenceData.push({
						name: 'NIST',
						description: rec.product,
						url: 'https://nvd.nist.gov/vuln/detail/' + key,
					});
                } else
                if (key.startsWith('CWE')) {
                    var a = key.split('-');
                    if (a.length > 1) {
                        rec.cves.push({
                            id: key,
                            url: 'https://cwe.mitre.org/data/definitions/' + a[1] + '.html',
                        });
						rec.referenceData.push({
							name: 'MITRE',
							description: rec.product,
							url: 'https://cwe.mitre.org/data/definitions/' + a[1] + '.html',
						});
                    }
                }
            }
            return rec;
        },

        convertSeverity: function(grd_severity) {
            if (!grd_severity) return '';
            // CRITICAL,MAJOR,MINOR,INFO,CAUTION,CAT I,CAT II,CAT III
            switch (grd_severity.toUpperCase()) {
                case 'CRITICAL':
                    return 1;
                case 'MAJOR':
                    return 2;
                case 'MINOR':
                    return 3;
                case 'CAUTION':
                    return 4;
                case 'INFO':
                    return 5;
            }
            return 5;
        },

        type: 'GuardiumProcessorVulnerabilityTest'
    });]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-01-14 16:22:58</sys_created_on>
        <sys_id>72716ae987094950387c64280cbb35b3</sys_id>
        <sys_mod_count>64</sys_mod_count>
        <sys_name>GuardiumProcessorVulnerabilityTest</sys_name>
        <sys_package display_value="IBM Guardium Data Protection" source="x_ibmrt_gdpva">400d30552fa0111049572f2ef699b65a</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="IBM Guardium Data Protection">400d30552fa0111049572f2ef699b65a</sys_scope>
        <sys_update_name>sys_script_include_72716ae987094950387c64280cbb35b3</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-02-06 19:09:38</sys_updated_on>
    </sys_script_include>
</record_update>
