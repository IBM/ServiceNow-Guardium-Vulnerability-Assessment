<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_ibmrt_gdpva.GuardiumRunIntegration</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Finds and runs specified integration</description>
        <name>GuardiumRunIntegration</name>
        <script><![CDATA[var GuardiumRunIntegration = Class.create();

GuardiumRunIntegration.getInstance = function() {
    return new GuardiumRunIntegration();
};

GuardiumRunIntegration.prototype = {
	// minimum delay between jobs is 3 minutes
	DELAY: 180000,
	// used to introduce a random delay of 0 to 3 secs between jobs
	DELAY_RANDOM: 3000,
	// wait for running assessment tests
	WAIT_FOR_JOBS: false, //gs.getProperty('x_ibmrt_gdpva.queue.wait_for_running_jobs')
	
    initialize: function() {
        // 10 hours of 3 minute intervals (20 per hour)
        this.MAX_ATTEMPTS = gs.getProperty('x_ibmrt_gdpva.queue.max_attempts', 200);
        // run NVD
        this.RUN_NVD = gs.getProperty('x_ibmrt_gdpva.queue.run_nvd_integration', true);
    },

    // Integration definitions
    integrations: {
        "asset:managed_unit": {
            name: 'Managed Unit',
            active: true,
            type: 'asset:managed_unit',
            sys_id: 'eea35a7e87410110387c64280cbb35bc',
            full_sync_only: false,
            dependencies: []
        },
        "asset:database": {
            name: 'Data Source',
            active: true,
            type: 'asset:database',
            sys_id: '22a35a7e87410110387c64280cbb35bc',
            full_sync_only: false,
            dependencies: []
        },
        /*
        "asset:database_group": {
            name: 'Data Source Group',
            active: true,
            type: 'asset:database_group',
            sys_id: '2aa35a7e87410110387c64280cbb35b8',
            full_sync_only: false,
            dependencies: ["asset:database"]
        },
        "test_result:exception": {
            name: 'Test Exception',
            active: true,
            type: 'test_result:exception',
            sys_id: '36a316fe87410110387c64280cbb35e7',
            full_sync_only: false,
            dependencies: [
                "asset:database", "asset:database_group", "vulnerability:assessment", "vulnerability:third_party_test"
            ]
        },
        */
        "test_result:summary": {
            name: 'Test Summary',
            active: true,
            type: 'test_result:summary',
            sys_id: '32a316fe87410110387c64280cbb35e9',
            full_sync_only: false,
			remote: true,
            dependencies: ["vulnerability:assessment"]
        },
        "test_result:details": {
            name: 'Test Detailed Result',
            active: true,
            type: 'test_result:details',
            sys_id: 'b2a316fe87410110387c64280cbb35e8',
            full_sync_only: false,
			remote: true,
            dependencies: ["asset:database", "vulnerability:third_party_test"]
        },
        "vulnerability:assessment": {
            name: 'Vulnerability Assessment',
            active: true,
            type: 'vulnerability:assessment',
            sys_id: '7378eb4c871d0510387c64280cbb35a6',
            full_sync_only: false,
            dependencies: []
        },
        "vulnerability:third_party_test": {
            name: 'Vulnerability Test',
            active: true,
            type: 'vulnerability:third_party_test',
            sys_id: '6ea35a7e87410110387c64280cbb35bd',
            full_sync_only: false,
            dependencies: []
        }
    },

    // Use getIntegrationJobs instead of integrations
    getIntegrationJobs: function(integ_types) {
        var jobs = [];
        for (var integType in this.integrations) {
            if (!this.integrations[integType].active) {
                continue;
            }
            if (integ_types) {
                if (!integ_types.includes(integType)) {
                    continue;
                }
            }
            jobs.push(this.integrations[integType]);
        }
        return jobs;
    },

    // Find the integration specified by type:subtype and run with parameters
    byType: function(integType, params) {
        var gr_integ = new GlideRecord('sn_vul_integration');
        var integDef = this.integrations[integType];
        if (!integDef || !gr_integ.get(integDef.sys_id)) {
            throw new Error("Invalid integration reference: " + integType);
        }
        var oInteg = {
            name: gr_integ.getDisplayValue(gr_integ.getDisplayName()),
            sys_id: gr_integ.getUniqueValue(),
            sync_sys_id: '',
            count: 0
        };
        this.queue(gr_integ, oInteg, params);
    },

    // Run the specified integration with parameters
    byRef: function(integSysId, params, checkLastRun) {
        var gr_integ = new GlideRecord('sn_vul_integration');
        if (!gr_integ.get(integSysId)) {
            throw new Error("Invalid integration reference: " + integSysId);
        }
        var oInteg = {
            name: gr_integ.getDisplayValue(gr_integ.getDisplayName()),
            sys_id: gr_integ.getUniqueValue(),
            sync_sys_id: '',
            count: 0
        };
        if (checkLastRun) {
            var gr_run = new GlideRecord('sn_vul_integration_run');
            gr_run.addQuery("state", '=', "complete");
            gr_run.addQuery('substate', '=', 'success');
            gr_run.orderByDesc('sys_created_on');
            gr_run.setLimit(1);
            gr_run.query();
            if (gr_run.next()) {
                var dt = gr_run.getValue('start_datetime');
                if (dt) {
                    var dt_now = new GlideDateTime();
                    var dt_then = new GlideDateTime(dt);

                    // subtract to get the number of milliseconds difference
                    var millis = dt_now.getNumericValue() - dt_then.getNumericValue();
                    var hours = Math.ceil(millis / 3600000);
                    if (hours < 168) {
                        // skip: since it has been less than one week since last successful run
                        GuardiumLog.debug(
                            'Skip running ' + oInteg.name + ' since last successful run was less than a week ago.',
                            this.type,
                            dt
                        );
                        return;
                    }
                }
            }
        }

        // Run the integration asynchronously
        this.queue(gr_integ, oInteg, params);
    },

    // Queue up integration to be run
    queue: function(gr_integ, integ_info, params) {
        var oParameters = this.checkParameters(params, true);
        var oInteg = this.checkParameters(integ_info, true);
        GuardiumLog.debug(
            'parameters <- queue',
            this.type, {
                integration: oInteg,
                parameters: oParameters
            }
        );

        // initialize sync_integration record
        var gr_integ_sync = this._getSyncChildRecord(oInteg, oParameters, true);
        if ('complete' == gr_integ_sync.getValue('state')) {
            GuardiumLog.info(
                'Integration is marked as complete: "' + oInteg.name + '"',
                this.type
            );
            return;
        }

        // Is this integration active?
        if ('1' != gr_integ.getValue('active')) {
            this._completeAndFail(gr_integ_sync, oParameters, 'Skip data import. Integration "' + gr_integ.getDisplayValue() + '" is not active');
            return;
        }

        // Does this integration have any dependencies that have not completed?
        if (this._hasOutstandingDependencies(gr_integ, oParameters)) {
            try {
                this._queueDelay(gr_integ, oInteg, oParameters);
            } catch (e) {
                GuardiumLog.error('', this.type, e);
                this._completeAndFail(gr_integ_sync, oParameters, e.message || e);
            }
            return;
        }

        // Discover and wait for any assessment jobs to complete before running test_result:summary
        if (this._hasOutstandingJobs(gr_integ, oParameters)) {
            try {
                this._queueDelay(gr_integ, oInteg, oParameters);
            } catch (e) {
                GuardiumLog.error('', this.type, e);
                this._completeAndFail(gr_integ_sync, oParameters, e.message || e);
            }
            return;
        }

        // Dependencies have been resolved, run it!
        var run_sys_id = this._run(gr_integ, oInteg, oParameters);

        // Update sync record with run info
        if (gr_integ_sync && run_sys_id) {
            gr_integ_sync.setValue('integration_run', run_sys_id);
            gr_integ_sync.setValue('state', 'running');
            gr_integ_sync.update();
        }
    },

    _queueDelay: function(gr_integ, oInteg, oParameters) {
        // Check number of attempts
        oInteg['count'] = 1 + (oInteg['count'] - 0 || 0);
        if (oInteg['count'] >= this.MAX_ATTEMPTS) {
            throw new Error('Queue integration "' + oInteg.name +
                '" too many attempts. Cancelling.'
            );
        }

        // Queue up the event for later processing
        var randomDelay = (Math.random() * this.DELAY_RANDOM).toFixed(0) - 0;
        var queueDelay = randomDelay + this.DELAY;

        var dtCheckLater = new GlideDateTime();
        dtCheckLater.add(queueDelay); // check again in ~3 minutes
        GuardiumLog.debug(
            'Check dependencies for [' + oInteg.name + '] again at: ' + dtCheckLater.getDisplayValue(),
            this.type
        );
        gs.eventQueueScheduled(
            'x_ibmrt_gdpva.QueueDataImport',
            gr_integ,
            JSON.stringify(oInteg),
            JSON.stringify(oParameters),
            dtCheckLater
        );
    },

    _run: function(gr_integ, oInteg, oParameters) {
        var name = gr_integ.getDisplayValue(gr_integ.getDisplayName());
        var vi_run_sys_id;
        try {
            // Create a run record to cause the Integration job to kick off
            var gr_vi_run = new GlideRecord("sn_vul_integration_run");
            gr_vi_run.initialize();
            gr_vi_run.setValue('parameters', oParameters ? JSON.stringify(oParameters) : '');
            gr_vi_run.setValue('integration', gr_integ.sys_id);
            gr_vi_run.setValue('implementation', gr_integ.getValue("instance"));
            gr_vi_run.setValue('source', GuardiumAPI.TITLE);
            gr_vi_run.setValue('state', 'ready');
            vi_run_sys_id = gr_vi_run.insert();

            // business rule calls startIntegrationRun onInsert
            // var vi_process_sys_id =
            //  (new sn_vul.VulnerabilityIntegrationUtils()).startIntegrationRun(gr_vi_run);

            // Announce start
            GuardiumLog.info(
                'Integration is starting: "' + name + '"',
                this.type
            );

        } catch (e) {
            GuardiumLog.error('', this.type, e);
            throw e;
        }

        // return the sys_id of the integ_run
        return vi_run_sys_id;
    },

    // Does this integration have dependencies?
    _hasOutstandingDependencies: function(gr_integ, oParameters) {
        var gr_sync;
        try {
            gr_sync = this._getSyncRecord(oParameters);
        } catch (e) {
            GuardiumLog.error('', this.type, e);
            return false;
        }

        var oInfo = {
            integration: {
                name: gr_integ.getDisplayValue(gr_integ.getDisplayName()),
                sys_id: gr_integ.getUniqueValue()
            },
            full_sync: '1' == gr_sync.getValue('full_sync'),
            incomplete: [],
            completed: this._getSyncChildIDArray(gr_sync.getUniqueValue(), true),
        };

        // es5 allows String.includes but not Array.includes
        var completed_integrations = oInfo['completed'].join(';');

        // get all dependency records and check if they have finished
        var integDef = this._lookupIntegrationByRef(gr_integ.getUniqueValue());
        if (integDef && integDef.dependencies) {
            for (var i = 0; i < integDef.dependencies.length; i++) {
                var dependDef = this.integrations[integDef.dependencies[i]];

                // if not doing full_sync, don't check for full_sync_only deps
                if (oInfo.full_sync || !dependDef.full_sync_only) {
                    if (!completed_integrations.includes(dependDef.sys_id)) {
                        // check to make sure the integration is active before adding to incomplete
                        var gr_dep_integ = new GlideRecord('sn_vul_integration');
                        if (gr_dep_integ.get(dependDef.sys_id) && '1' == gr_dep_integ.getValue('active')) {
                            // waiting on this integration to complete
                            oInfo.incomplete.push({
                                name: dependDef.name,
                                sys_id: dependDef.sys_id
                            });
                        }
                    }
                }
            }
        }

        if (oInfo.incomplete.length) {
            // Some dependencies have not yet completed
            GuardiumLog.debug(
                'Waiting on dependencies',
                this.type,
                oInfo
            );
            return true;
        }

        return false;
    },

    _hasOutstandingJobs: function(gr_integ, oParameters) {
        if (this.WAIT_FOR_JOBS && 'summary' == gr_integ.getValue('sub_type')) {
            // Run report, look for != "COMPLETE"
            try {
                var asJobs = [];

                // Authenticate
                var gAPI = new GuardiumAPI(GuardiumAPI.getGlideRecordCM(oParameters['cm_sys_id'], true));
                gAPI.authenticate();

                // Fetch running jobs
                var reportParams = {
                    QUERY_FROM_DATE: 'NOW -1 DAY',
                    "successful-login": "true",
                    "JobEntityDesc": "%",
                    "JobType": "ASSESSMENT"
                };
                var response = gAPI.getReportData(
                    "Guardium Job Queue", reportParams, 1, "Queue Time", true
                );
                if (response && response.data && response.data.length) {

                    // If any are not complete, then there are outstanding jobs
                    for (var i = 0; i < response.data.length; i++) {
                        var oJob = response.data[i];
                        switch ((oJob['Status']).toUpperCase()) {
                            case 'WAITING':
                            case 'RUNNING':
                                asJobs.push({
                                    name: oJob['Guardium Job Description'],
                                    status: oJob['Status']
                                });
                                break;

                            case 'HALTED':
                            case 'COMPLETED':
                            default:
                                break;
                        }
                    }
                }
                if (asJobs.length) {
                    GuardiumLog.debug(
                        'Waiting on assessment tests',
                        this.type,
                        asJobs
                    );
                    return true;
                }

            } catch (e) {
                GuardiumLog.error('', this.type, e);
            }
        }
        return false;
    },

    _lookupIntegrationByRef: function(sysId) {
        for (var integType in this.integrations) {
            if (sysId == this.integrations[integType].sys_id) {
                return this.integrations[integType];
            }
        }
        return null;
    },

    // Return the sync record referenced by the parameters
    _getSyncRecord: function(oParameters) {
        var gr_sync = new GlideRecord(GuardiumAPI.TABLE_CM_SYNC);
        var sync_sys_id = oParameters;
        if ('object' == typeof(oParameters)) {
            sync_sys_id = oParameters['sync_sys_id'];
        }
        if (sync_sys_id && gr_sync.get(sync_sys_id)) {
            return gr_sync;
        }
        throw new Error("Invalid parameters:\n " + (oParameters ? JSON.stringify(oParameters) : null));
    },

    _getSyncChildRecord: function(oInteg, oParameters, createIfNull) {

        // Attempt to open the record specified in oInteg
        var gr_integ_sync = new GlideRecord(GuardiumAPI.TABLE_SYNC_INTEG);
        if (!oInteg || !oInteg['sync_sys_id'] || !gr_integ_sync.get(oInteg['sync_sys_id'])) {

            // No valid child ref passed.  Use parent to find or create child.
            if (oParameters['sync_sys_id']) {
                var integ_sys_id = oInteg['sys_id'];
                gr_integ_sync.addQuery('parent', '=', oParameters['sync_sys_id']);
                gr_integ_sync.addQuery('integration', '=', integ_sys_id);
                gr_integ_sync.setLimit(1);
                gr_integ_sync.query();
                if (!gr_integ_sync.next() && createIfNull) {
                    // Create a new child record as none exists
                    gr_integ_sync.initialize();
                    gr_integ_sync.setValue('parent', oParameters['sync_sys_id']);
                    gr_integ_sync.setValue('integration', integ_sys_id);
                    // Save reference
                    if (oInteg) {
                        oInteg['sync_sys_id'] = gr_integ_sync.insert();
                    }
                }
            }
        }
        return gr_integ_sync;
    },

    _getSyncChildIDArray: function(sync_sys_id, completed) {
        var asChildren = [];
        var gr_integ_sync = new GlideRecord(GuardiumAPI.TABLE_SYNC_INTEG);
        gr_integ_sync.addQuery('parent', '=', sync_sys_id);
        gr_integ_sync.addQuery('state', completed ? '=' : '!=', 'complete');
        gr_integ_sync.query();
        while (gr_integ_sync.next()) {
            asChildren.push(gr_integ_sync.getValue('integration'));
        }
        return asChildren;
    },

    // Called by a business rule when sn_vul_integration_run is complete
    complete: function(gr_integ_run) {
        try {
            var oInteg = {
                name: gr_integ_run.getDisplayValue('integration'),
                sys_id: gr_integ_run.getValue('integration')
            };
            var oParameters = this.checkParameters(
                gr_integ_run.getValue('parameters'), true
            );
            GuardiumLog.debug(
                'parameters <- complete',
                this.type, {
                    integration: oInteg,
                    parameters: oParameters
                }
            );

            // Complete the sync_integ record
            var gr_integ_sync = this._getSyncChildRecord(
                oInteg, oParameters
            );
            gr_integ_sync.setValue('successful', true);
            gr_integ_sync.setValue('state', 'complete');
            gr_integ_sync.update();

        } catch (e) {
            GuardiumLog.error('', this.type, e);
        }
    },

    // Called by queue on error
    _completeAndFail: function(gr_integ_sync, oParameters, errMsg) {
        try {
            // Complete the sync_integ record
            gr_integ_sync.setValue('successful', false);
            gr_integ_sync.setValue('state', 'complete');
            gr_integ_sync.setValue('message',
                'Failed: ' + errMsg
            );
            gr_integ_sync.update();

        } catch (e) {
            GuardiumLog.error('', this.type, e);
        }
    },

    checkProgress: function(sync_sys_id) {
        try {
            if (!sync_sys_id) throw new Error('Invalid parent sync id');
            var gr_sync = this._getSyncRecord(sync_sys_id);
            // Check for incomplete child processes
            var asIncomplete = this._getSyncChildIDArray(
                gr_sync.getUniqueValue(), false);
            if (asIncomplete.length) {
                // Not done yet
                return;
            }

            // COMPLETE! All children are complete, gather results
            var completed = 0;
            var successful = 0;
            var asMsg = [];

            var gr_integ_sync = new GlideRecord(GuardiumAPI.TABLE_SYNC_INTEG);
            gr_integ_sync.addQuery('parent', gr_sync.getUniqueValue());
            gr_integ_sync.query();
            while (gr_integ_sync.next()) {
                completed += 1;
                if ('1' == gr_integ_sync.getValue('successful')) {
                    successful += 1;
                }
                if (gr_integ_sync.getValue('message')) {
                    asMsg.push(gr_integ_sync.getValue('message'));
                }
            }

            gr_sync.setValue('state', 'complete');
            gr_sync.setValue('completed', completed);
            gr_sync.setValue('successful', successful);
            gr_sync.setValue('message', asMsg.join('\n'));

            gr_sync.update();
        } catch (e) {
            GuardiumLog.error('', this.type, e);
        }
    },

    getValueFromParameters: function(params, key) {
        var oParameters = this.checkParameters(params);
        return oParameters[key] || '';
    },

    checkParameters: function(params, errorIfNull) {
        var oParameters = {};
        if ('string' == typeof(params)) {
            try {
                oParameters = JSON.parse(params);
            } catch (e) {
                GuardiumLog.warn(
                    'Could not parse parameters "' + params + '"',
                    this.type
                );
            }
        } else
        if ('object' == typeof(params) && null != params) {
            oParameters = params;
        }

        if (errorIfNull && !oParameters) {
            throw new Error('Parameters are null');
        }
        return oParameters || {};
    },

    type: 'GuardiumRunIntegration'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-09-13 11:52:56</sys_created_on>
        <sys_id>d4e1b75b1b3dd910489ceb522a4bcbed</sys_id>
        <sys_mod_count>12</sys_mod_count>
        <sys_name>GuardiumRunIntegration</sys_name>
        <sys_package display_value="IBM Guardium Data Protection" source="x_ibmrt_gdpva">400d30552fa0111049572f2ef699b65a</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="IBM Guardium Data Protection">400d30552fa0111049572f2ef699b65a</sys_scope>
        <sys_update_name>sys_script_include_d4e1b75b1b3dd910489ceb522a4bcbed</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-05-10 19:38:59</sys_updated_on>
    </sys_script_include>
</record_update>
