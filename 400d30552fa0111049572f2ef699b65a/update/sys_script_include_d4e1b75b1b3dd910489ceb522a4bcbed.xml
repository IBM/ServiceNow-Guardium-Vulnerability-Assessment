<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_ibmrt_gdpva.GuardiumRunIntegration</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Finds and runs specified integration</description>
        <name>GuardiumRunIntegration</name>
        <script><![CDATA[var GuardiumRunIntegration = {
    // 10 hours of 3 minute intervals (20 per hour)
    MAX_ATTEMPTS: gs.getProperty('x_ibmrt_gdpva.queue.max_attempts', 200),
    // minimum delay between jobs is 3 minutes
    DELAY: 180000,
    // used to introduce a random delay of 0 to 3 secs between jobs
    DELAY_RANDOM: 3000,
    // wait for running assessment tests
    WAIT_FOR_JOBS: false, //gs.getProperty('x_ibmrt_gdpva.queue.wait_for_running_jobs'),

    // Deprecated definitions
    integrations: {
        "asset:managed_unit": {
			name: 'Managed Unit',
			sys_id: 'eea35a7e87410110387c64280cbb35bc',
			full_sync_only: false,
			dependencies: []
		},
        "asset:database": {
			name: 'Data Source',
			sys_id: '22a35a7e87410110387c64280cbb35bc',
			full_sync_only: false,
			dependencies: []
		},
        "asset:database_group": {
			name: 'Data Source Group',
			sys_id: '2aa35a7e87410110387c64280cbb35b8',
			full_sync_only: false,
			dependencies: ["asset:database"]
		},
        "test_result:summary": {
			name: 'Test Summary',
			sys_id: '32a316fe87410110387c64280cbb35e9',
			full_sync_only: false,
			dependencies: ["vulnerability:assessment"]
		},
        "test_result:details": {
			name: 'Test Detailed Result',
			sys_id: 'b2a316fe87410110387c64280cbb35e8',
			full_sync_only: false,
			dependencies: ["asset:database", "vulnerability:third_party_test"]
		},
        "test_result:exception": {
			name: 'Test Exception',
			sys_id: '36a316fe87410110387c64280cbb35e7',
			full_sync_only: false,
			dependencies: [
				"asset:database", "asset:database_group", "vulnerability:assessment", "vulnerability:third_party_test"
			]
		},
        "vulnerability:assessment": {
			name: 'Vulnerability Assessment',
			sys_id: '7378eb4c871d0510387c64280cbb35a6',
			full_sync_only: false,
			dependencies: []
		},
        "vulnerability:third_party_test": {
			name: 'Vulnerability Test',
			sys_id: '6ea35a7e87410110387c64280cbb35bd',
			full_sync_only: true,
			dependencies: []
		}
    },

    // Use getIntegrationJobs instead of integrations
    getIntegrationJobs: function(integ_types) {
        var jobs = [];
		for (var integType in GuardiumRunIntegration.integrations) {
			if (integ_types) {
				if (!integ_types.includes(integType)) {
					continue;
				}
			}
            jobs.push(GuardiumRunIntegration.integrations[integType]);
        }
        return jobs;
    },

    // Find the integration specified by type:subtype and run with parameters
    byType: function(integType, params) {
		var gr_integ = new GlideRecord(GuardiumAPI.TABLE_VUL_INTEG);
        var integDef = GuardiumRunIntegration.integrations[integType];
		if (!integDef || !gr_integ.get(integDef.sys_id)) {
            throw new Error("Invalid integration reference: " + integType);
        }
        var oInteg = {
            name: gr_integ.getDisplayValue(gr_integ.getDisplayName()),
            sys_id: gr_integ.getUniqueValue(),
            sync_sys_id: '',
            count: 0
        };
        GuardiumRunIntegration.queue(gr_integ, oInteg, params);
    },

    // Run the specified integration with parameters
    byRef: function(integSysId, params) {
        var gr_integ = new GlideRecord(GuardiumAPI.TABLE_VUL_INTEG);
        if (!gr_integ.get(integSysId)) {
            throw new Error("Invalid integration reference: " + integSysId);
        }
        var oInteg = {
            name: gr_integ.getDisplayValue(gr_integ.getDisplayName()),
            sys_id: gr_integ.getUniqueValue(),
            sync_sys_id: '',
            count: 0
        };
        GuardiumRunIntegration.queue(gr_integ, oInteg, params);
    },

    // Queue up integration to be run
    queue: function(gr_integ, integ_info, params) {
        var oParameters = GuardiumRunIntegration.checkParameters(params, true);
        var oInteg = GuardiumRunIntegration.checkParameters(integ_info, true);
        GuardiumLog.debug(
            'parameters <- queue',
            GuardiumRunIntegration.type, {
                integration: oInteg,
                parameters: oParameters
            }
        );

        // initialize sync_integration record
        var gr_integ_sync = GuardiumRunIntegration._getSyncChildRecord(oInteg, oParameters, true);
        if ('complete' == gr_integ_sync.getValue('state')) {
            GuardiumLog.info(
                'Integration is marked as complete: "' + oInteg.name + '"',
                GuardiumRunIntegration.type
            );
			return;
        }

        // Is this integration active?
        if (false == gr_integ.getValue('active')) {
            GuardiumRunIntegration._completeAndFail(gr_integ_sync, oParameters, 'Skip data import. Integration "' + gr_integ.getDisplayValue() + '" is not active');
            return;
        }

        // Does this integration have any dependencies that have not completed?
        if (GuardiumRunIntegration._hasOutstandingDependencies(gr_integ, oParameters)) {
            try {
                GuardiumRunIntegration._queueDelay(gr_integ, oInteg, oParameters);
            } catch (e) {
                GuardiumLog.error('', GuardiumRunIntegration.type, e);
                GuardiumRunIntegration._completeAndFail(gr_integ_sync, oParameters, e.message || e);
            }
            return;
        }

        // Discover and wait for any assessment jobs to complete before running test_result:summary
        if (GuardiumRunIntegration._hasOutstandingJobs(gr_integ, oParameters)) {
            try {
                GuardiumRunIntegration._queueDelay(gr_integ, oInteg, oParameters);
            } catch (e) {
                GuardiumLog.error('', GuardiumRunIntegration.type, e);
                GuardiumRunIntegration._completeAndFail(gr_integ_sync, oParameters, e.message || e);
            }
            return;
        }

        // Dependencies have been resolved, run it!
        var run_sys_id = GuardiumRunIntegration._run(gr_integ, oInteg, oParameters);

        // Update sync record with run info
        if (gr_integ_sync && run_sys_id) {
            gr_integ_sync.setValue('integration_run', run_sys_id);
            gr_integ_sync.setValue('state', 'running');
            gr_integ_sync.update();
        }
    },

    _queueDelay: function(gr_integ, oInteg, oParameters) {
        // Check number of attempts
        oInteg['count'] = 1 + (oInteg['count'] - 0 || 0);
        if (oInteg['count'] >= GuardiumRunIntegration.MAX_ATTEMPTS) {
            throw new Error('Queue integration "' + oInteg.name +
                '" too many attempts. Cancelling.'
            );
        }

        // Queue up the event for later processing
        var randomDelay = (Math.random() * GuardiumRunIntegration.DELAY_RANDOM).toFixed(0) - 0;
        var queueDelay = randomDelay + GuardiumRunIntegration.DELAY;

        var dtCheckLater = new GlideDateTime();
        dtCheckLater.add(queueDelay); // check again in ~3 minutes
        GuardiumLog.debug(
			'Check dependencies for [' + oInteg.name + '] again at: ' + dtCheckLater.getDisplayValue(), 
			GuardiumRunIntegration.type
		);
        gs.eventQueueScheduled(
            'x_ibmrt_gdpva.QueueDataImport',
            gr_integ,
            JSON.stringify(oInteg),
            JSON.stringify(oParameters),
            dtCheckLater
        );
    },

    _run: function(gr_integ, oInteg, oParameters) {
        var name = gr_integ.getDisplayValue(gr_integ.getDisplayName());
        var vi_run_sys_id;
        try {
            // Create a run record to cause the Integration job to kick off
            var gr_vi_run = new GlideRecord("sn_vul_integration_run");
            gr_vi_run.initialize();
            gr_vi_run.setValue('parameters', oParameters ? JSON.stringify(oParameters) : '');
            gr_vi_run.setValue('integration', gr_integ.sys_id);
            gr_vi_run.setValue('implementation', gr_integ.getValue("instance"));
            gr_vi_run.setValue('source', GuardiumAPI.TITLE);
            gr_vi_run.setValue('state', 'ready');
            vi_run_sys_id = gr_vi_run.insert();

            // business rule calls startIntegrationRun onInsert
            // var vi_process_sys_id =
            //  (new sn_vul.VulnerabilityIntegrationUtils()).startIntegrationRun(gr_vi_run);

            // Announce start
            GuardiumLog.info(
                'Integration is starting: "' + name + '"',
                GuardiumRunIntegration.type
            );

        } catch (e) {
            GuardiumLog.error('', GuardiumRunIntegration.type, e);
            throw e;
        }

        // return the sys_id of the integ_run
        return vi_run_sys_id;
    },

    // Does this integration have dependencies?
    _hasOutstandingDependencies: function(gr_integ, oParameters) {
        var gr_sync;
        try {
            gr_sync = GuardiumRunIntegration._getSyncRecord(oParameters);
        } catch (e) {
            GuardiumLog.error('', GuardiumRunIntegration.type, e);
            return false;
        }

        var oInfo = {
            integration: {
                name: gr_integ.getDisplayValue(gr_integ.getDisplayName()),
                sys_id: gr_integ.getUniqueValue()
            },
            full_sync: '1' == gr_sync.getValue('full_sync'),
            incomplete: [],
            completed: GuardiumRunIntegration._getSyncChildIDArray(gr_sync.getUniqueValue(), true),
        };

        // es5 allows String.includes but not Array.includes
        var completed_integrations = oInfo['completed'].join(';');

        // get all dependency records and check if they have finished
		var integDef = GuardiumRunIntegration._lookupIntegrationByRef(gr_integ.getUniqueValue());
		if (integDef && integDef.dependencies) {
			for (var i=0; i<integDef.dependencies.length; i++) {
				var dependDef = GuardiumRunIntegration.integrations[integDef.dependencies[i]];

				// if not doing full_sync, don't check for full_sync_only deps
				if (oInfo.full_sync || !dependDef.full_sync_only) {
					if (!completed_integrations.includes(dependDef.sys_id)) {
						// check to make sure the integration is active before adding to incomplete
						var gr_dep_integ = new GlideRecord(GuardiumAPI.TABLE_VUL_INTEG);
						if (gr_dep_integ.get(dependDef.sys_id) && '1' == gr_dep_integ.getValue('active')) {
							// waiting on this integration to complete
							oInfo.incomplete.push({
								name: dependDef.name,
								sys_id: dependDef.sys_id
							});
						}
					}
				}
			}
		}

        if (oInfo.incomplete.length) {
            // Some dependencies have not yet completed
            GuardiumLog.debug(
                'Waiting on dependencies',
                GuardiumRunIntegration.type,
                oInfo
            );
            return true;
        }

        return false;
    },

    _hasOutstandingJobs: function(gr_integ, oParameters) {
        if (GuardiumRunIntegration.WAIT_FOR_JOBS && 'summary' == gr_integ.getValue('sub_type')) {
            // Run report, look for != "COMPLETE"
            try {
                var asJobs = [];

                // Authenticate
                var gAPI = new GuardiumAPI(GuardiumAPI.getGlideRecordCM(oParameters['cm_sys_id'], true));
                gAPI.authenticate();

                // Fetch running jobs
                var reportParams = {
                    QUERY_FROM_DATE: 'NOW -1 DAY',
                    "successful-login": "true",
                    "JobEntityDesc": "%",
                    "JobType": "ASSESSMENT"
                };
                var response = gAPI.getReportData(
                    "Guardium Job Queue", reportParams, 1, "Queue Time", true
                );
                if (response && response.data && response.data.length) {

                    // If any are not complete, then there are outstanding jobs
                    for (var i = 0; i < response.data.length; i++) {
                        var oJob = response.data[i];
                        switch ((oJob['Status']).toUpperCase()) {
                            case 'WAITING':
                            case 'RUNNING':
                                asJobs.push({
                                    name: oJob['Guardium Job Description'],
                                    status: oJob['Status']
                                });
                                break;

                            case 'HALTED':
                            case 'COMPLETED':
                            default:
                                break;
                        }
                    }
                }
                if (asJobs.length) {
                    GuardiumLog.debug(
                        'Waiting on assessment tests',
                        GuardiumRunIntegration.type,
                        asJobs
                    );
                    return true;
                }

            } catch (e) {
                GuardiumLog.error('', GuardiumRunIntegration.type, e);
            }
        }
        return false;
    },
	
	_lookupIntegrationByRef: function(sysId) {
		for (var integType in GuardiumRunIntegration.integrations) {
			if (sysId == GuardiumRunIntegration.integrations[integType].sys_id) {
				return GuardiumRunIntegration.integrations[integType];
			}
		}
		return null;
	},

    // Return the sync record referenced by the parameters
    _getSyncRecord: function(oParameters) {
        var gr_sync = new GlideRecord(GuardiumAPI.TABLE_CM_SYNC);
        var sync_sys_id = oParameters;
        if ('object' == typeof(oParameters)) {
            sync_sys_id = oParameters['sync_sys_id'];
        }
        if (sync_sys_id && gr_sync.get(sync_sys_id)) {
            return gr_sync;
        }
        throw new Error("Invalid parameters:\n " + (oParameters ? JSON.stringify(oParameters) : null));
    },

    _getSyncChildRecord: function(oInteg, oParameters, createIfNull) {

        // Attempt to open the record specified in oInteg
        var gr_integ_sync = new GlideRecord(GuardiumAPI.TABLE_SYNC_INTEG);
        if (!oInteg || !oInteg['sync_sys_id'] || !gr_integ_sync.get(oInteg['sync_sys_id'])) {

            // No valid child ref passed.  Use parent to find or create child.
            if (oParameters['sync_sys_id']) {
                var integ_sys_id = oInteg['sys_id'];
                gr_integ_sync.addQuery('parent', '=', oParameters['sync_sys_id']);
                gr_integ_sync.addQuery('integration', '=', integ_sys_id);
                gr_integ_sync.setLimit(1);
                gr_integ_sync.query();
                if (!gr_integ_sync.next() && createIfNull) {
                    // Create a new child record as none exists
                    gr_integ_sync.initialize();
                    gr_integ_sync.setValue('parent', oParameters['sync_sys_id']);
                    gr_integ_sync.setValue('integration', integ_sys_id);
                    // Save reference
                    if (oInteg) {
                        oInteg['sync_sys_id'] = gr_integ_sync.insert();
                    }
                }
            }
        }
        return gr_integ_sync;
    },

    _getSyncChildIDArray: function(sync_sys_id, completed) {
        var asChildren = [];
        var gr_integ_sync = new GlideRecord(GuardiumAPI.TABLE_SYNC_INTEG);
        gr_integ_sync.addQuery('parent', '=', sync_sys_id);
        gr_integ_sync.addQuery('state', completed ? '=' : '!=', 'complete');
        gr_integ_sync.query();
        while (gr_integ_sync.next()) {
            asChildren.push(gr_integ_sync.getValue('integration'));
        }
        return asChildren;
    },

    // Called by a business rule when sn_vul_integration_run is complete
    complete: function(gr_integ_run) {
        try {
            var oInteg = {
                name: gr_integ_run.getDisplayValue('integration'),
                sys_id: gr_integ_run.getValue('integration')
            };
            var oParameters = GuardiumRunIntegration.checkParameters(
                gr_integ_run.getValue('parameters'), true
            );
            GuardiumLog.debug(
                'parameters <- complete',
                GuardiumRunIntegration.type, {
                    integration: oInteg,
                    parameters: oParameters
                }
            );

            // Complete the sync_integ record
            var gr_integ_sync = GuardiumRunIntegration._getSyncChildRecord(
                oInteg, oParameters
            );
            gr_integ_sync.setValue('successful', true);
            gr_integ_sync.setValue('state', 'complete');
            gr_integ_sync.update();

        } catch (e) {
            GuardiumLog.error('', GuardiumRunIntegration.type, e);
        }
    },

    // Called by queue on error
    _completeAndFail: function(gr_integ_sync, oParameters, errMsg) {
        try {
            // Complete the sync_integ record
            gr_integ_sync.setValue('successful', false);
            gr_integ_sync.setValue('state', 'complete');
            gr_integ_sync.setValue('message',
                'Failed: ' + errMsg
            );
            gr_integ_sync.update();

        } catch (e) {
            GuardiumLog.error('', GuardiumRunIntegration.type, e);
        }
    },

    checkProgress: function(sync_sys_id) {
        try {
			if (!sync_sys_id) throw new Error('Invalid parent sync id');
            var gr_sync = GuardiumRunIntegration._getSyncRecord(sync_sys_id);
            // Check for incomplete child processes
            var asIncomplete = GuardiumRunIntegration._getSyncChildIDArray(
                gr_sync.getUniqueValue(), false);
            if (asIncomplete.length) {
                // Not done yet
                return;
            }

            // COMPLETE! All children are complete, gather results
            var completed = 0;
            var successful = 0;
            var asMsg = [];

            var gr_integ_sync = new GlideRecord(GuardiumAPI.TABLE_SYNC_INTEG);
            gr_integ_sync.addQuery('parent', gr_sync.getUniqueValue());
            gr_integ_sync.query();
            while (gr_integ_sync.next()) {
                completed += 1;
                if ('1' == gr_integ_sync.getValue('successful')) {
                    successful += 1;
                }
                if (gr_integ_sync.getValue('message')) {
                    asMsg.push(gr_integ_sync.getValue('message'));
                }
            }

            gr_sync.setValue('state', 'complete');
            gr_sync.setValue('completed', completed);
            gr_sync.setValue('successful', successful);
            gr_sync.setValue('message', asMsg.join('\n'));

            gr_sync.update();
        } catch (e) {
            GuardiumLog.error('', GuardiumRunIntegration.type, e);
        }
    },

    getValueFromParameters: function(params, key) {
        var oParameters = GuardiumRunIntegration.checkParameters(params);
        return oParameters[key] || '';
    },

    checkParameters: function(params, errorIfNull) {
        var oParameters = {};
        if ('string' == typeof(params)) {
            try {
                oParameters = JSON.parse(params);
            } catch (e) {
                GuardiumLog.warn(
                    'Could not parse parameters "' + params + '"',
                    GuardiumRunIntegration.type
                );
            }
        } else
        if ('object' == typeof(params) && null != params) {
            oParameters = params;
        }

        if (errorIfNull && !oParameters) {
            throw new Error('Parameters are null');
        }
        return oParameters || {};
    },

    type: 'GuardiumRunIntegration'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-09-13 11:52:56</sys_created_on>
        <sys_id>d4e1b75b1b3dd910489ceb522a4bcbed</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_name>GuardiumRunIntegration</sys_name>
        <sys_package display_value="IBM Guardium Data Protection" source="x_ibmrt_gdpva">400d30552fa0111049572f2ef699b65a</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="IBM Guardium Data Protection">400d30552fa0111049572f2ef699b65a</sys_scope>
        <sys_update_name>sys_script_include_d4e1b75b1b3dd910489ceb522a4bcbed</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-04-28 14:14:37</sys_updated_on>
    </sys_script_include>
</record_update>
