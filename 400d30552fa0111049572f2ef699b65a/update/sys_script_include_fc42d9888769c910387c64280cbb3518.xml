<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_ibmrt_gdpva.GuardiumExportDatasource</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>GuardiumExportDatasource</name>
        <script><![CDATA[var GuardiumExportDatasource = Class.create();
GuardiumExportDatasource.PREFIX = "Export to Guardium: ";

GuardiumExportDatasource.prototype = {
    initialize: function() {
        this.GuardTransform = new GuardiumTransformMap();
        this._initializeTransformCacheDI();
        this._initializeTransformCacheDC();
    },

    /**
     * export database instances and catalogs that match the given rule
     */
    runRule: function(gr_rule) {
        if (!gr_rule || "1" != gr_rule.getValue('active')) {
            GuardiumLog.error(gr_rule ?
                "Selected rule is inactive: " + gr_rule.getValue('name') :
                "Selected rule has been deleted",
                this.type
            );
        }

        // build response
        var response = {};
        var cm_fqdn = gr_rule.getDisplayValue('fqdn_cm');
        // Find matching databases and run
        response[cm_fqdn] = this.exportAllMatchingInstances(gr_rule);
        // Return
        return response;
    },

    /**
     * run on all matching database instance records
     */
    run: function() {
        var total = 0;
        var exported = {};
        var hasRules = false;

        var gr_rule = new GlideRecord(GuardiumAPI.TABLE_EXP_TARGET);
        gr_rule.addActiveQuery();
        gr_rule.orderBy('order');
        gr_rule.query();
        while (gr_rule.next()) {
            hasRules = true;

            // build response
            var cm_fqdn = gr_rule.getDisplayValue('fqdn_cm');
            exported[cm_fqdn] = this.exportAllMatchingInstances(gr_rule);
            total += exported[cm_fqdn];
        }

        if (!total) {
            var msg = hasRules ?
                '\nNo databases matched any "Database Export Targets"' :
                '\nNo conditions defined in "Database Export Targets"';
            GuardiumLog.warn("No databases exported to IBM Guardium." + msg, this.type);
        }

        return exported;
    },

    /**
     * run on single database instance
     */
    runOnce: function(gr_db, isCatalog, action) {
        var cm_sys_id;
        var gr_rule;

        if ('delete' == action && !gr_db) {
            // Not much we can do here ... the database is gone
            return;
        }

        // is this Database Instance already linked to a Guardium data source?
        var gr_ds = this.getGuardiumRecord(gr_db);
        if (gr_ds) {
            cm_sys_id = gr_ds.getValue('fqdn_cm');
        }

        if ('delete' == action) {
            try {
                gr_ds.deleteDatasource();
                return true;
            } catch (e) {
                GuardiumLog.error('', this.type, e);
            }
            return;
        }

        // is this a Catalog?
        if (isCatalog) {
            var db_sys_id = gr_db.getValue('database_instance');
            if (!db_sys_id) {
                var name = gr_db.getDisplayValue(gr_db.getDisplayName());
                throw new Error('Catalog, "' + name + '", is not linked to a database instance.');
            }

            // Catalog will be synched as part of scanning the parent database instance
            gr_db = new GlideRecord(GuardiumAPI.TABLE_DB);
            gr_db.get(db_sys_id);
        }

        // match conditions in order to get the rule and export script
        gr_rule = this.matchesCondition(gr_db, cm_sys_id);
        if (gr_rule && !cm_sys_id) {
            cm_sys_id = gr_rule.getValue('fqdn_cm');
        }

        if (gr_rule && cm_sys_id) {
            var gAPI = this._initAPI(cm_sys_id);
            if (!gAPI) return;
            return this.exportInstance(gAPI, gr_db, gr_ds, gr_rule);
        }

        var msg = 'Cancelled due to no matching export conditions.';
        GuardiumLog.warn(msg, this.type);
        return;
    },

    exportAllMatchingInstances: function(gr_rule) {
        var cm_sys_id = gr_rule.getValue('fqdn_cm');
        var exported = 0;
        var matched = {};

        var gAPI = this._initAPI(cm_sys_id);
        if (!gAPI) return exported;

        // run condition rule to see if it matches any database
        GuardiumLog.debug(
            "Export central manager: " + gr_rule.getDisplayValue('fqdn_cm') +
            "\n condition: " + gr_rule.getValue('condition_rules'),
            this.type
        );

        var gr_db = new GlideRecord(GuardiumAPI.TABLE_DB);
        gr_db.addEncodedQuery(gr_rule.getValue('condition_rules'));
        gr_db.query();
        while (gr_db.next()) {
            var db_sys_id = gr_db.getUniqueValue();

            // do not export the same DB to two or more CM's
            if (matched[db_sys_id]) {
                continue;
            }
            // keep track of exported DBs
            matched[db_sys_id] = true;
            exported += 1;

            // open record with actual table to get all the necessary fields
            var gr_actual = gr_db;
            var table = gr_db.getRecordClassName();
            if (GuardiumAPI.TABLE_DB != table) {
                try {
                    gr_actual = new GlideRecord(table);
                    if (!gr_actual.get(db_sys_id)) {
                        gr_actual = gr_db;
                    }
                } catch (errDi) {
                    GuardiumLog.warn('Table access error: ' + table, this.type, errDi);
                }
            }
            exported += this.exportInstance(gAPI, gr_actual, this.getGuardiumRecord(gr_db), gr_rule);
        }
        return exported;
    },

    exportInstance: function(gAPI, gr_db, gr_ds, gr_rule) {
        var isUpdate = !!gr_ds;

        var ds_orig = this.transformInstance(gr_db, gr_ds, true);
        if (!ds_orig) return 0;

        // Let customer modify the record before exporting to Guardium
        var ds_custom = this.runScript(gr_db, ds_orig, gr_rule);
        ds_orig = ds_custom || ds_orig;

        // create linked ServiceNow record 
        gr_ds = this.createOrUpdateGuardiumRecord(
            gAPI, gr_db.getTableName(), gr_db.getUniqueValue(), ds_orig, gr_ds);

        // send to Guardium by queuing the DS
        GuardiumLog.debug('Queue Database Instance Export: ' + gr_db.getDisplayValue(), this.type);
        var count = 1;

        // Process Database Catalogs even if Database Instance fails
        return count + this.exportCatalogs(gAPI, gr_db, gr_rule);
    },

    exportCatalogs: function(gAPI, gr_db, gr_rule) {
        var exported = 0;
        var oInfo = {
            di_name: gr_db.getDisplayValue(),
            di_sys_id: gr_db.getUniqueValue()
        };
        var gr_dc = new GlideRecord(GuardiumAPI.TABLE_DC);
        gr_dc.addQuery('database_instance', '=', gr_db.getUniqueValue());
        gr_dc.query();
        while (gr_dc.next()) {
            // Get the record with its specified table to get all the extra fields
            var gr_actual = gr_dc;
            var table = gr_dc.getRecordClassName();
            var dc_sys_id = gr_dc.getUniqueValue();
            oInfo['dc_name'] = gr_dc.getDisplayValue();
            oInfo['dc_sys_id'] = dc_sys_id;

            GuardiumLog.debug('Queue Database Catalog Export: ' + gr_dc.getDisplayValue(), this.type, oInfo);

            if (GuardiumAPI.TABLE_DC != table) {
                try {
                    gr_actual = new GlideRecord(table);
                    if (!gr_actual.get(dc_sys_id)) {
                        gr_actual = gr_dc;
                    }
                } catch (errDc) {
                    GuardiumLog.warn('Table access error: ' + table, this.type, errDc);
                }
            }
            exported += this.exportCatalog(gAPI, gr_db, gr_actual, gr_rule);
        }
        return exported;
    },

    exportCatalog: function(gAPI, gr_db, gr_dc, gr_rule) {
        // check for presence of Guardium record
        var gr_ds = this.getGuardiumRecord(gr_dc);
        var isUpdate = !!gr_ds;

        var ds_orig = this.transformCatalog(gr_db, gr_dc, gr_ds, true);
        if (!ds_orig) return 0;

        // Let customer modify the record before exporting to Guardium
        var ds_custom = this.runScript(gr_dc, ds_orig, gr_rule);
        ds_orig = ds_custom || ds_orig;

        // create linked ServiceNow record 
        gr_ds = this.createOrUpdateGuardiumRecord(
            gAPI, gr_db.getTableName(), gr_dc.getUniqueValue(), ds_orig, gr_ds);

        // send to Guardium by queuing the DS
        return 1;
    },

    process: function(gr_ds, cm_sys_id, isDelete) {
        if (!cm_sys_id) {
            cm_sys_id = gr_ds.getValue('fqdn_cm');
        }
        if (!cm_sys_id) {
            throw new Error('Invalid central manager');
        }

        var gAPI = this._connectToCM(cm_sys_id);
        if (!gAPI) return;

        if (isDelete) {
            return this.deleteDatasource(gAPI, gr_ds);
        }

        var sys_id = gr_ds.getValue('database_instance');
        if (!sys_id) {
            // Data source is not linked to ServiceNow, ignore
            gr_ds.setValue('action', 'synchronized');
            gr_ds.setWorkflow(false);
            gr_ds.update();
            return false;
        }

		var ds_json = this.transformDatasource(gr_ds);
        var count = this.exportDatasource(gAPI, ds_json);
        // update ServiceNow record 
        gr_ds.setValue('datasource_id', (ds_json.id).toFixed(0));
        gr_ds.setValue('source_id', this.getUniqueID(ds_json, gAPI.cm.sys_id));
        gr_ds.setValue('action', 'synchronized');
        gr_ds.setWorkflow(false);
        gr_ds.update();
        return count;
    },

    deleteDatasource: function(gAPI, gr_ds) {
        // Delete the record
        gAPI.del('delete_datasource_by_id', {
            id: gr_ds.getValue('datasource_id')
        });

        // Success!
        GuardiumLog.info('Successfully deleted data source: "' +
            gr_ds.getDisplayValue(gr_ds.getDisplayName()) + '" from ' + gAPI.cm.name, this.type);

        // Delete datasource from ServiceNow
        gr_ds.setValue('status', 'Deprecated');
        gr_ds.deleteRecord();
        return true;
    },

    exportDatasource: function(gAPI, ds_orig) {
        var isUpdate = !!ds_orig.id; // true if record has an id
        var response = null;
        var err = null;

        // Fix up user, password, and other properties if necessary
        var ds = this.postTransform(ds_orig, isUpdate);

        // export to Guardium
        GuardiumLog.debug(
            (isUpdate ? 'Update' : 'Create') +
            ' Data Source "' + (ds['name'] || ds['newName']) + '" on ' + gAPI.cm.name,
            this.type, ds
        );

        try {
            response = isUpdate ?
                gAPI.put(ds.id ? 'update_datasource_by_id' : 'update_datasource_by_name', ds) :
                gAPI.post('datasource', ds);
        } catch (e) {
            if (isUpdate && e.code && (e.message || e).includes("doesn't exist")) {
                // Record might have been deleted on Guardium, try POST
                isUpdate = false;
                ds = this.postTransform(ds_orig, isUpdate);
                GuardiumLog.debug(
					'Error: ' + e.message + '\nTry ' +
                    (isUpdate ? 'Update' : 'Create') +
                    ' Data Source "' + (ds['name'] || ds['newName']) + '" on ' + gAPI.cm.name,
                    this.type, ds
                );
                try {
                    response = gAPI.post('datasource', ds);
                } catch (e1) {
                    err = e1;
                }
            } else
            if (!isUpdate && e.code && (e.message || e).includes("already exists")) {
                // Record might have been deleted in ServiceNow, try PUT
                isUpdate = true;
                ds = this.postTransform(ds_orig, isUpdate);
                GuardiumLog.debug(
					'Error: ' + e.message + '\nTry ' +
                    (isUpdate ? 'Update' : 'Create') +
                    ' Data Source "' + (ds['name'] || ds['newName']) + '" on ' + gAPI.cm.name,
                    this.type, ds
                );
                try {
                    delete ds.id;
                } catch (e3) {}
                try {
                    response = gAPI.put('update_datasource_by_name', ds);
                } catch (e2) {
                    err = e2;
                }
            } else {
                err = e;
            }
        }

        if (response && response.data) {
            // Success
            var count = 0;
            ds_orig.id = this.toInteger(response.data['ID'] || ds_orig.id);
            if (ds_orig.id) {
                count = 1;
            } else {
                GuardiumLog.warn(
                    'Invalid response saving datasource - "' + gr_db.getValue('name') + '"',
                    this.type,
                    response.body
                );
            }
            return count;

        } else {
            // Error from Guardium
            var errMsg = 'Error "' + ds_orig['name'] + '"' + (response ? "\n" + response.body : '');
            GuardiumLog.error(errMsg, this.type, err);
            throw new Error(errMsg + '\n' + err.message);
        }
    },

    transformDatasource: function(gr_ds) {
        var props = this.getTransformProperties(
            gr_ds.getValue('datasource_type'), null, gr_ds.getValue('tcp_port'));

        var dbType = props['database_type_override'] || props['database_type'] || '';
        if (!dbType) {
			throw new Error(
				'Invalid Data Source Type: ' + gr_ds.getValue('database_type') +
                '\nData Source Name: ' + gr_ds.getDisplayValue()
			);
        }

        var ds = {
            "application": "Security Assessment",
            "awsSecretsManagerConfigName": "",
            "compatibilityMode": "",
            "conProperty": gr_ds.getValue('attributes') || '',
            "customProps": gr_ds.getValue('custom_fields') || '',
            "customURL": gr_ds.getValue('custom_url') || '',
            "cyberarkConfigName": "",
            "cyberarkObjectName": "",
            "dbInstanceAccount": "",
            "dbInstanceDirectory": "",
            "dbName": "",
            "description": gr_ds.getValue('description') || '',
            "externalPasswordTypeName": "",
            "hashicorpConfigName": "",
            "hashicorpPath": "",
            "hashicorpRole": "",
            "host": gr_ds.getValue('fqdn') || '',
            "id": this.toInteger(gr_ds.getValue('datasource_id') || ''),
            "importServerSSLcert": "0",
            "KerberosConfigName": "",
            "name": gr_ds.getValue('name') || '',
            "newName": gr_ds.getValue('name') || '',
            "password": gr_ds.getValue('password') || '',
            "port": gr_ds.getValue('tcp_port') || '',
            "region": "",
            "savePassword": "1",
            "secretName": "",
            "serviceName": "",
            "severity": "",
            "shared": "true",
            "type": dbType,
            "useExternalPassword": "0",
            "useKerberos": "0",
            "useLDAP": "0",
            "user": gr_ds.getValue('user_name') || '',
            "useSSL": "0"
        };
        return ds;
    },


    hasGuardiumRecord: function(gr_db) {
        return !!this.getGuardiumRecord(gr_db);
    },

    getGuardiumRecord: function(gr_db) {
        if (gr_db) {
            var gr_gdp = new GlideRecord(GuardiumAPI.TABLE_DB_GDP);
            gr_gdp.addQuery('database_instance', '=', gr_db.getUniqueValue());
            gr_gdp.addQuery('status', '!=', 'Deprecated');
            gr_gdp.orderBy('sys_created_on'); // oldest first
            gr_gdp.query();
            if (gr_gdp.next()) {
                return gr_gdp;
            }
        }
        return null;
    },

	toInteger: function(n) {
		return (n - 0).toFixed(0) - 0;
	},
	
    getUniqueID: function(rec, cm_sys_id) {
        return [
            cm_sys_id, rec.host,
            rec.port, rec.serviceName,
            rec.dbName, rec.user
        ].join(':');
    },

    createOrUpdateGuardiumRecord: function(gAPI, ci_table, ci_sys_id, ds, gr_ds) {
        var props = this.getTransformProperties(null, ci_table, ds.port);
        var isNew = false;
        var gr_gdp = new GlideRecord(GuardiumAPI.TABLE_DB_GDP);
        if (!gr_ds || !gr_gdp.get(gr_ds.getUniqueValue())) {
            gr_gdp.initialize();
            isNew = true;
        }

        // ServiceNow is source of truth
        gr_gdp.setValue('fqdn_cm', gAPI.cm.sys_id);
        gr_gdp.setValue('name', ds.name);
        gr_gdp.setValue('fqdn', ds.host);
        gr_gdp.setValue('tcp_port', ds.port);
        gr_gdp.setValue('datasource_id', '' + (ds.id || ''));
        gr_gdp.setValue('datasource_type', (props['database_type'] || '').trim());
        gr_gdp.setValue('database_instance', ci_sys_id);
        gr_gdp.setValue('database_instance_class', (props['database_instance_class'] || GuardiumAPI.TABLE_DB));
        gr_gdp.setValue('database_name', ds.dbName);
        gr_gdp.setValue('service_name', ds.serviceName);
        gr_gdp.setValue('custom_fields', ds.customProps);
        gr_gdp.setValue('custom_url', ds.customURL);
        gr_gdp.setValue('user_name', ds.user);
        gr_gdp.setValue('password', ds.password);
        gr_gdp.setValue('action', 'export');
        gr_gdp.setValue('source_id', this.getUniqueID(ds, gAPI.cm.sys_id));

        if (isNew) {
            gr_gdp.insert();
        } else {
            gr_gdp.update();
        }
        return gr_gdp;
    },

    matchesCondition: function(gr_db, cm_sys_id) {
        // returns the rule that matches
        var gr_rule = new GlideRecord(GuardiumAPI.TABLE_EXP_TARGET);
        gr_rule.addActiveQuery();
        if (cm_sys_id) {
            gr_rule.addQuery('fqdn_cm', '=', cm_sys_id);
        }
        gr_rule.orderBy('order');
        gr_rule.query();
        while (gr_rule.next()) {
            // run condition rule to see if it matches the database
            var gr_rec = new GlideRecord(GuardiumAPI.TABLE_DB);
            gr_rec.addQuery('sys_id', '=', gr_db.getUniqueValue());
            gr_rec.addEncodedQuery(gr_rule.getValue('condition_rules'));
            gr_rec.query();
            if (gr_rec.next()) {
                GuardiumLog.debug(
                    'Found database export rule for ' + gr_db.getDisplayValue(gr_db.getDisplayName()),
                    this.type,
                    gr_rule.getDisplayValue(gr_rule.getDisplayName())
                );
                return gr_rule;
            }
        }

        // no matching rule
        GuardiumLog.debug(
            'Could not find a database export rule for ' + gr_db.getDisplayValue(gr_db.getDisplayName()),
            this.type,
            'No matching rule!'
        );
        return null;
    },

    runScript: function(gr_db, ds, gr_rule) {
        // Run any scripts created by the customer
        try {
            var returnObj = {};
            var evaluator = new GlideScopedEvaluator();
            evaluator.putVariable("database", gr_db);
            evaluator.putVariable("guardium_export", ds);
            evaluator.putVariable("returnObj", returnObj);
            return evaluator.evaluateScript(gr_rule, "database_export_script");
        } catch (e) {
            GuardiumLog.error('', this.type, e);
        }
        return ds;
    },

    postTransform: function(ds_orig, isUpdate) {
        // Check for empty user and password ... The Guardium API requires a value
        if (this.isFalse(ds_orig['useExternalPassword']) &&
            this.isFalse(ds_orig['useKerberos']) &&
            this.isFalse(ds_orig['useLDAP']) && !ds_orig['password']) {
            ds_orig['password'] = '*empty*';
        }
        if (this.isFalse(ds_orig['useExternalPassword']) &&
            this.isFalse(ds_orig['useKerberos']) &&
            this.isFalse(ds_orig['useLDAP']) && !ds_orig['user']) {
            ds_orig['user'] = '*empty*';
        }

        // Remove any empty user/password on update
        // Make sure id is an integer, not a string
        if (ds_orig['id']) {
            ds_orig.id = this.toInteger(ds_orig.id);
        }

        var ds = {}; // create a new copy before deleting anything

        // Do not pass NULL, pass EMPTY string instead
        for (var p in ds_orig) {
            ds[p] = ds_orig[p] || '';
        }

		// delete customProps as an error will occur if passed to create or update datasource
		delete ds.customProps;
		
        if (isUpdate) {
            // remove any members that cannot be in "update"
            try {
                delete ds["application"];
                delete ds["compatibilityMode"];
                delete ds["type"];
                if (ds["id"]) {
                    if (!ds["newName"]) ds["newName"] = ds["name"];
                    delete ds["name"];
                } else {
                    delete ds["id"]; // cannot be 0 or empty
                }

                if (this.isEmpty(ds_orig['user'])) {
                    delete ds_orig['user'];
                }
                if (this.isEmpty(ds_orig['password'])) {
                    delete ds_orig['password'];
                }
            } catch (e) {}
        } else {
            // remove any members that cannot be in "insert"
            try {
                delete ds["id"];
                delete ds["newName"];
            } catch (e) {}
        }
        return ds;
    },

    isFalse: function(val) {
        return (!val || "0" == val || "false" == val.toLowerCase());
    },

    isEmpty: function(val) {
        return (!val || "0" == val || "undefined" == val.toLowerCase() ||
            "null" == val.toLowerCase() || '*empty*' == val.toLowerCase());
    },

    transformInstance: function(gr_db, gr_gdp, generateUniqueName) {
        // since there is no Guardium API to find a db by fqdn and port,
        //  assume that the Guardium DB's have already been pushed to ServiceNow
        var class_name = gr_db.getValue('sys_class_name');

        // get the Guardium Datasource record associated with the instance
        var ds_id = gr_gdp ? gr_gdp.getValue('datasource_id') : '';
        if (this.isEmpty(ds_id)) ds_id = '';
        var ds_type = gr_gdp ? gr_gdp.getValue('datasource_type') : '';
        var tcp_port = (gr_db.getValue('tcp_port') || '') + '';

        // A database that might be able to export to Guardium
        var props = this.getTransformProperties(ds_type, class_name, tcp_port);

        // create in Guardium
        var ds = {
            "application": "Security Assessment",
            "awsSecretsManagerConfigName": "",
            "compatibilityMode": "",
            "conProperty": gr_db.getValue('running_process_key_parameters') || '',
            "customProps": gr_db.getValue('attributes') || '',
            "customURL": gr_db.getValue('running_process_command') || '',
            "cyberarkConfigName": "",
            "cyberarkObjectName": "",
            "dbInstanceAccount": "",
            "dbInstanceDirectory": "",
            "dbName": "",
            "description": gr_db.getValue('description') || '',
            "externalPasswordTypeName": "",
            "hashicorpConfigName": "",
            "hashicorpPath": "",
            "hashicorpRole": "",
            "host": gr_db.getValue('fqdn') || '',
            "id": this.toInteger(ds_id),
            "importServerSSLcert": "0",
            "KerberosConfigName": "",
            "name": gr_db.getValue('name') || '',
            "newName": gr_db.getValue('name') || '',
            "password": gr_db.getValue('password') || '',
            "port": (tcp_port || props['tcp_port'] || '').trim(),
            "region": "",
            "savePassword": "1",
            "secretName": "",
            "serviceName": "",
            "severity": "",
            "shared": "true",
            "type": (props['database_type_override'] || props['database_type'] || '').trim(),
            "useExternalPassword": "0",
            "useKerberos": "0",
            "useLDAP": "0",
            "user": gr_db.getValue('user_name') || '',
            "useSSL": "0"
        };

        // Build unique name
        var asName = [];
        if (ds['name']) asName.push(ds['name']);
        if (ds['host']) asName.push(ds['host']);
        if (ds['port']) asName.push(ds['port']);

        // Get database_name parameter from special class or from Guardium attributes
        if (props.database_name) {
            ds["dbName"] = gr_db.getValue(props.database_name.trim()) || '';
            if (ds['dbName']) asName.push(ds['dbName']);
        }

        // Get service_name parameter from special class or from Guardium attributes
        if (props.service_name) {
            ds["serviceName"] = gr_db.getValue(props.service_name.trim()) || '';
            if (ds['serviceName']) asName.push(ds['serviceName']);
        }

        // Unique name
        if (generateUniqueName || !ds["name"]) {
            var title = '';
            for (var i = 0; i < asName.length; i++) {
                if (title.toLowerCase().includes(asName[i].toLowerCase())) {
                    continue;
                }
                title = title + '-' + asName[i];
            }
            if (0 == title.indexOf('-')) {
                title = title.substring(1);
            }
            ds['name'] = ds['newName'] = title;
        }

        // Return formatted JSON object
        return ds;
    },

    transformCatalog: function(gr_db, gr_dc, gr_gdp, generateUniqueName) {
        // base the Guardium datasource on the ServiceNow Database Instance
        var ds = this.transformInstance(gr_db, gr_gdp, false);
        if (!ds) return;

        // update Guardium datasource with ServiceNow Database Catalog values
        ds["conProperty"] = gr_dc.getValue('running_process_key_parameters');
        ds["customProps"] = gr_dc.getValue('attributes');
        ds["customURL"] = gr_dc.getValue('running_process_command');
        ds["description"] = gr_dc.getValue('description');

        if (ds.id) {
            generateUniqueName = false;
        }

        // Build a unique name
        var asName = [];
        if (ds['name']) asName.push(ds['name']);
        if (ds['port']) asName.push(ds['port']);

        // get special "Database Name" and "Service Name" fields
        var props = this.getCatalogFieldMap(ds.type);

        // Get database_name parameter from special class or from Guardium attributes
        if (props.database_name) {
            ds["dbName"] = gr_dc.getValue(props.database_name.trim()) || '';
            if (ds['dbName']) asName.push(ds['dbName']);
        }

        // Get service_name parameter from special class or from Guardium attributes
        if (props.service_name) {
            ds["serviceName"] = gr_dc.getValue(props.service_name.trim()) || '';
            if (ds['serviceName']) asName.push(ds['serviceName']);
        }

        // Unique name
        if (generateUniqueName || !ds['name']) {
            var title = '';
            for (var i = 0; i < asName.length; i++) {
                if (title.toLowerCase().includes(asName[i].toLowerCase())) {
                    continue;
                }
                title = title + '-' + asName[i];
            }
            if (0 == title.indexOf('-')) {
                title = title.substring(1);
            }
            ds['name'] = ds['newName'] = title;
        }

        // Return formatted JSON object
        return ds;
    },

    _initAPI: function(cm_sys_id) {
        if (!cm_sys_id) {
            // get first active CM
            var gr_cm = GuardiumAPI.getFirstActiveCM();
            if (gr_cm) {
                cm_sys_id = gr_cm.getUniqueValue();
            }
        }
        if (!cm_sys_id) {
            GuardiumLog.error("No active Central Manager defined", this.type);
            return null;
        }

        return new GuardiumAPI(GuardiumAPI.getGlideRecordCM(cm_sys_id, true));
    },

    _connectToCM: function(cm_sys_id) {
        var gAPI;
        try {
            // establish connection to the chosen CM
            gAPI = this._initAPI(cm_sys_id);
            gAPI.authenticate();
            return gAPI;
        } catch (errAuth) {
            GuardiumLog.error("Unable to authenticate" + (gAPI ? ' with ' + gAPI.cm.name : ''), this.type);
            return null;
        }
    },

    getTransformProperties: function(ds_type, class_name, tcp_port) {
        var props;
        if (ds_type) {
            props = this._lookupByType[ds_type];
        }
        if (!props && GuardiumAPI.TABLE_DB != class_name) {
            props = this._lookupByClass[class_name];
        }
        if (!props || GuardiumAPI.TABLE_DB == props['database_instance_class']) {
            props = this._lookupByPort[tcp_port];
        }
        return props || {};
    },

    _initializeTransformCacheDI: function() {
        this._lookupByClass = {};
        this._lookupByType = {};
        this._lookupByPort = {};

        var map = this.GuardTransform.getMapDI();
        for (var ds_type in map) {
            var entry = map[ds_type];
            var class_name = entry['database_instance_class'];
            var tcp_port = entry['tcp_port'] || '';

            if (!this._lookupByClass[class_name]) this._lookupByClass[class_name] = entry;
            if (!this._lookupByType[ds_type]) this._lookupByType[ds_type] = entry;
            if (!this._lookupByPort[tcp_port]) this._lookupByPort[tcp_port] = entry;
        }
    },

    getCatalogFieldMap: function(dbType) {
        return this._catalogByType[dbType] || this._catalogByType['*'];
    },

    _initializeTransformCacheDC: function() {
        this._catalogByType = this.GuardTransform.getMapDC();
    },

    type: 'GuardiumExportDatasource'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-02-03 18:14:34</sys_created_on>
        <sys_id>fc42d9888769c910387c64280cbb3518</sys_id>
        <sys_mod_count>136</sys_mod_count>
        <sys_name>GuardiumExportDatasource</sys_name>
        <sys_package display_value="IBM Guardium Vulnerability Assessment" source="x_ibmrt_gdpva">400d30552fa0111049572f2ef699b65a</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="IBM Guardium Vulnerability Assessment">400d30552fa0111049572f2ef699b65a</sys_scope>
        <sys_update_name>sys_script_include_fc42d9888769c910387c64280cbb3518</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2022-11-02 18:08:34</sys_updated_on>
    </sys_script_include>
</record_update>
