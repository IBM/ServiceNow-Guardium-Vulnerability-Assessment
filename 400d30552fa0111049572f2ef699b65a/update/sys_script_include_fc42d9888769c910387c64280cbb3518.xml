<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_ibmrt_gdpva.GuardiumExportDatasource</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>GuardiumExportDatasource</name>
        <script><![CDATA[var GuardiumExportDatasource = Class.create();
GuardiumExportDatasource.PREFIX = "Export to Guardium: ";

GuardiumExportDatasource.prototype = {
    initialize: function() {
        this.GuardTransform = new GuardiumTransformMap();
        this._initializeTransformCacheDI();
        this._initializeTransformCacheDC();
    },

    /**
     * export database instances and catalogs that match the given rule
     */
    runRule: function(gr_rule) {
        if (!gr_rule || "1" != gr_rule.getValue("active")) {
            GuardiumLog.error(gr_rule ?
                "Selected rule is inactive: " + gr_rule.getValue('name') :
                "Selected rule has been deleted",
                this.type
            );
        }

        // build response
        var response = {};
        var cm_fqdn = gr_rule.getDisplayValue('fqdn_cm');
        // Find matching databases and run
        response[cm_fqdn] = exportAllMatchingInstances(gr_rule);
        // Return
        return response;
    },

    /**
     * run on all matching database instance records
     */
    run: function() {
        var total = 0;
        var response = {};
        var hasRules = false;
        var matched = {};

        var gr_rule = new GlideRecord(GuardiumAPI.TABLE_EXP_TARGET);
        gr_rule.addActiveQuery();
        gr_rule.orderBy('order');
        gr_rule.query();
        while (gr_rule.next()) {
            hasRules = true;

            // build response
            var cm_fqdn = gr_rule.getDisplayValue('fqdn_cm');
            response[cm_fqdn] = exportAllMatchingInstances(gr_rule);
        }

        if (!total) {
            var msg = hasRules ?
                '\nNo databases matched any "Database Export Targets"' :
                '\nNo conditions defined in "Database Export Targets"';
            GuardiumLog.warn("No databases exported to IBM Guardium." + msg, this.type);
        }

        return response;
    },

    /**
     * run on single database instance
     */
    runOnce: function(gr_db, force, isCatalog) {
        var cm_sys_id;
        var gr_rule;

        // is this Database Instance already linked to a Guardium data source?
        var gr_ds = this.getGuardiumRecord(gr_db);
        if (gr_ds) {
            cm_sys_id = gr_ds.getValue('fqdn_cm');
        }

        // is this a Catalog?
        if (isCatalog) {
            var db_sys_id = gr_db.getValue('database_instance');
            if (!db_sys_id) {
                var name = gr_db.getDisplayValue(gr_db.getDisplayName());
                throw new Error('Catalog, "' + name + '", is not linked to a database instance.');
            }

            // Catalog will be synched as part of scanning the parent database instance
            gr_db = new GlideRecord(GuardiumAPI.TABLE_DB);
            gr_db.get(db_sys_id);
        }

        // match conditions in order to get the rule and export script
        gr_rule = this.matchesCondition(gr_db, cm_sys_id);
        if (gr_rule && !cm_sys_id) {
            cm_sys_id = gr_rule.getValue('fqdn_cm');
        }

        if (cm_sys_id) {
            var gAPI = this._connectToCM(cm_sys_id);
            if (!gAPI) return;
            return this.exportInstance(gAPI, gr_db, gr_ds, gr_rule);
        }

        var msg = 'Cancelled due to no matching export conditions.';
        GuardiumLog.warn(msg, this.type);
        return;
    },

    exportAllMatchingInstances: function(gr_rule) {
        var cm_sys_id = gr_rule.getValue('fqdn_cm');
        var cm_fqdn = gr_rule.getDisplayValue('fqdn_cm');
        var exported = 0;

        var gAPI = this._connectToCM(cm_sys_id);
        if (!gAPI) return exported;

        // run condition rule to see if it matches any database
        GuardiumLog.debug("Export central manager: " + cm_fqdn +
            "\n condition: " + gr_rule.getValue('condition_rules'), this.type);

        var gr_db = new GlideRecord(GuardiumAPI.TABLE_DB);
        gr_db.addEncodedQuery(gr_rule.getValue('condition_rules'));
        gr_db.query();
        while (gr_db.next()) {
            var db_sys_id = gr_db.getUniqueValue();

            // do not export the same DB to two or more CM's
            if (matched[db_sys_id]) {
                continue;
            }
            // keep track of exported DBs
            matched[db_sys_id] = true;
            total += 1;

            // open record with actual table to get all the necessary fields
            var gr_actual = gr_db;
            var table = gr_db.getRecordClassName();
            if (GuardiumAPI.TABLE_DB != table) {
                gr_actual = new GlideRecord(table);
                if (!gr_actual.get(db_sys_id)) {
                    gr_actual = gr_db;
                }
            }
            exported += this.exportInstance(gAPI, gr_actual, this.getGuardiumRecord(gr_db), gr_rule);
        }
        return exported;
    },

    exportInstance: function(gAPI, gr_db, gr_ds, gr_rule) {
        var isUpdate = !!gr_ds;

        var ds_orig = this.transformInstance(gr_db, gr_ds, true);
        if (!ds_orig) return 0;

        // Let customer modify the record before exporting to Guardium
        var ds_custom = this.runScript(gr_db, ds_orig, gr_rule);
        ds_orig = ds_custom || ds_orig;

        // Fix up user, password, and other properties if necessary
        var ds = this.postTransform(ds_orig, isUpdate);

        // export to Guardium
        GuardiumLog.info('Export database ""' + gr_db.getValue('name') + '" to ' + gAPI.cm.fqdn, this.type, ds);

        var response = null;
        var err = null;
        var count = 0;
        try {
            response = isUpdate ?
                gAPI.put(ds.id ? 'update_datasource_by_id' : 'update_datasource_by_name', ds) :
                gAPI.post('datasource', ds);
        } catch (e) {
            if (isUpdate && (e.code || (e.message || e).contains("doesn't exist"))) {
                // Record might have been deleted on Guardium, try POST
                isUpdate = false;
                ds = this.postTransform(ds_orig, isUpdate);
                try {
                    response = gAPI.post('datasource', ds);
                } catch (e1) {
                    err = e1;
                }
            } else
            if (!isUpdate && (e.code || (e.message || e).contains("already exists"))) {
                // Record might have been deleted in ServiceNow, try PUT
                isUpdate = true;
                ds = this.postTransform(ds_orig, isUpdate);
                try {
                    delete ds.id;
                } catch (e3) {}
                try {
                    response = gAPI.put('update_datasource_by_name', ds);
                } catch (e2) {
                    err = e2;
                }
            } else {
                err = e;
            }
        }

        if (response && response.data) {
            // Success
            var ds_id = response.data['ID'];
            if (ds_id) {
                if (ds_id != ds.id) {
                    count = 1;
                    // update ServiceNow record with sync info
                    gr_ds = this.createGuardiumRecord(gAPI, gr_db, ds);
                }

            } else {
                GuardiumLog.info(
                    'Invalid response - "' + gr_db.getValue('name') + '"',
                    this.type,
                    response.body
                );
            }
        } else {
            // Error from Guardium
            GuardiumLog.warn(
                'Invalid response - "' + gr_db.getValue('name') + '"' + (response ? "\n" + response.body : ''),
                this.type,
                err
            );
        }

        // Process Database Catalogs even if Database Instance fails
        return count + this.exportCatalogs(gAPI, gr_db, gr_rule);
    },

    exportCatalogs: function(gAPI, gr_db, gr_rule) {
        var exported = 0;
        var gr_dc = new GlideRecord(GuardiumAPI.TABLE_DC);
        gr_dc.addQuery('database_instance', '=', gr_db.getUniqueValue());
        gr_dc.query();
        while (gr_dc.next()) {
            // Get the record with its specified table to get all the extra fields
            var gr_actual = gr_dc;
            var table = gr_dc.getRecordClassName();
            var dc_sys_id = gr_dc.getUniqueValue();
            if (GuardiumAPI.TABLE_DC != table) {
                gr_actual = new GlideRecord(table);
                if (!gr_actual.get(dc_sys_id)) {
                    gr_actual = gr_dc;
                }
            }
            exported += this.exportCatalog(gAPI, gr_db, gr_actual, gr_rule);
        }
        return exported;
    },

    exportCatalog: function(gAPI, gr_db, gr_dc, gr_rule) {
        // check for presence of Guardium record
        var gr_ds = this.getGuardiumRecord(gr_dc);
        var isUpdate = !!gr_ds;

        var ds_orig = this.transformCatalog(gr_db, gr_dc, gr_ds, true);
        if (!ds_orig) return 0;

        // Let customer modify the record before exporting to Guardium
        var ds_custom = this.runScript(gr_dc, ds_orig, gr_rule);
        ds_orig = ds_custom || ds_orig;

        // Fix up user and password, if necessary
        var ds = this.postTransform(ds_orig, isUpdate);

        var response = null;
        var err = null;
        try {
            response = isUpdate ?
                gAPI.put(ds.id ? 'update_datasource_by_id' : 'update_datasource_by_name', ds) :
                gAPI.post('datasource', ds);
        } catch (e) {
            if (isUpdate && (e.code || (e.message || e).contains("doesn't exist"))) {
                // Record might have been deleted on Guardium, try POST
                isUpdate = false;
                ds = this.postTransform(ds_orig, isUpdate);
                try {
                    response = gAPI.post('datasource', ds);
                } catch (e1) {
                    err = e1;
                }
            } else
            if (!isUpdate && (e.code || (e.message || e).contains("already exists"))) {
                // Record might have been deleted in ServiceNow, try PUT
                isUpdate = true;
                ds = this.postTransform(ds_orig, isUpdate);
                try {
                    delete ds.id;
                } catch (e3) {}
                try {
                    response = gAPI.put('update_datasource_by_name', ds);
                } catch (e2) {
                    err = e2;
                }
            } else {
                err = e;
            }
        }

        if (response && response.data) {
            // Success
            ds.id = response.data['ID'];
            if (ds.id) {
                if (!isUpdate) {
                    // update ServiceNow record with sync info
                    this.createGuardiumRecord(gAPI, gr_dc, ds);
                }
                return true;
            } else {
                GuardiumLog.info(
                    'Invalid response - "' + gr_db.getValue('name') + '"',
                    this.type,
                    response.body
                );
            }
        } else {
            // Error from Guardium
            GuardiumLog.error(
                'Error "' + gr_db.getValue('name') + '"' + (response ? "\n" + response.body : ''),
                this.type,
                err
            );

        }
    },

    hasGuardiumRecord: function(gr_db) {
        return !!this.getGuardiumRecord(gr_db);
    },

    getGuardiumRecord: function(gr_db) {
        if (gr_db) {
            var gr_gdp = new GlideRecord(GuardiumAPI.TABLE_DB_GDP);
            gr_gdp.addQuery('database_instance', '=', gr_db.getUniqueValue());
            gr_gdp.orderBy('sys_created_on'); // oldest first
            gr_gdp.query();
            if (gr_gdp.next()) {
                return gr_gdp;
            }
        }
        return null;
    },

    createGuardiumRecord: function(gAPI, gr_db, ds) {
        var gr_gdp = new GlideRecord(GuardiumAPI.TABLE_DB_GDP);
        gr_gdp.initialize();
        gr_gdp.setValue('fqdn_cm', gAPI.cm.sys_id);
        gr_gdp.setValue('name', ds.name);
        gr_gdp.setValue('datasource_id', '' + ds.id);
        gr_gdp.setValue('database_instance', gr_db.getUniqueValue());
        gr_gdp.setValue('database_name', ds.dbName);
        gr_gdp.setValue('service_name', ds.serviceName);
        gr_gdp.insert();
        return gr_gdp;
    },

    matchesCondition: function(gr_db, cm_sys_id) {
        // returns the rule that matches

        var gr_rule = new GlideRecord(GuardiumAPI.TABLE_EXP_TARGET);
        gr_rule.addActiveQuery();
        if (cm_sys_id) {
            gr_rule.addQuery('fqdn_cm', '=', cm_sys_id);
        }
        gr_rule.orderBy('order');
        gr_rule.query();
        while (gr_rule.next()) {
            // run condition rule to see if it matches the database
            var gr_rec = new GlideRecord(GuardiumAPI.TABLE_DB);
            gr_rec.addQuery('sys_id', '=', gr_db.getUniqueValue());
            gr_rec.addEncodedQuery(gr_rule.getValue('condition_rules'));
            gr_rec.query();
            if (gr_rec.next()) {
                return gr_rule;
            }
        }

        // no matching rule
        return null;
    },

    runScript: function(gr_db, ds, gr_rule) {
        // Run any scripts created by the customer
        try {
            var evaluator = new GlideScopedEvaluator();
            evaluator.putVariable("database", gr_db);
            evaluator.putVariable("guardium_export", ds);
            var ds_updated = evaluator.evaluateScript(gr_rule, "database_export_script");
            if (ds_updated) {
                return ds_updated;
            }
        } catch (e) {
            GuardiumLog.error('', this.type, e);
        }
        return ds;
    },

    postTransform: function(ds_orig, isUpdate) {
        // Check for empty user and password ... The Guardium API requires a value
        if (this.isFalse(ds_orig['useExternalPassword']) &&
            this.isFalse(ds_orig['useKerberos']) &&
            this.isFalse(ds_orig['useLDAP']) && !ds_orig['password']) {
            ds_orig['password'] = '*empty*';
        }
        if (this.isFalse(ds_orig['useExternalPassword']) &&
            this.isFalse(ds_orig['useKerberos']) &&
            this.isFalse(ds_orig['useLDAP']) && !ds_orig['user']) {
            ds_orig['user'] = '*empty*';
        }

        // Make sure id is an integer, not a string
        if (ds_orig['id']) {
            ds_orig.id = ds_orig.id - 0;
        }

        var ds = {}; // create a new copy before deleting anything

        // Do not pass NULL, pass EMPTY string instead
        for (var p in ds_orig) {
            ds[p] = ds_orig[p] || '';
        }

        if (isUpdate) {
            // remove any members that cannot be in "update"
            try {
                delete ds["application"];
                delete ds["compatibilityMode"];
                delete ds["type"];
                if (ds["id"]) {
                    if (!ds["newName"]) ds["newName"] = ds["name"];
                    delete ds["name"];
                } else {
                    delete ds["id"];
                }
            } catch (e) {}
        } else {
            // remove any members that cannot be in "insert"
            try {
                delete ds["id"];
                delete ds["newName"];
            } catch (e) {}
        }
        return ds;
    },

    isFalse: function(val) {
        return (!val || "0" == val || "false" == val.toLowerCase());
    },

    transformInstance: function(gr_db, gr_gdp, generateUniqueName) {
        // since there is no Guardium API to find a db by fqdn and port,
        //  assume that the Guardium DB's have already been pushed to ServiceNow
        var class_name = gr_db.getValue('sys_class_name');

        // get the Guardium Datasource record associated with the instance
        var ds_id = gr_gdp ? gr_gdp.getValue('datasource_id') : '';
        var ds_type = gr_gdp ? gr_gdp.getValue('datasource_type') : '';
        var tcp_port = gr_db.getValue('tcp_port');

        // A database that might be able to export to Guardium
        var props = this.getTransformProperties(ds_type, class_name, tcp_port);
        if (!props) {
            GuardiumLog.warn(
                'Cannot determine database type - "' + gr_db.getValue('name') + '"',
                this.type
            );
            props = {};
        }

        // create in Guardium
        var ds = {
            "application": "Security Assessment",
            "awsSecretsManagerConfigName": "",
            "compatibilityMode": "",
            "conProperty": gr_db.getValue('attributes'),
            "customProps": gr_db.getValue('running_process_key_parameters'),
            "customURL": gr_db.getValue('running_process_command'),
            "cyberarkConfigName": "",
            "cyberarkObjectName": "",
            "dbInstanceAccount": "",
            "dbInstanceDirectory": "",
            "dbName": "",
            "description": gr_db.getValue('description'),
            "externalPasswordTypeName": "",
            "hashicorpConfigName": "",
            "hashicorpPath": "",
            "hashicorpRole": "",
            "host": gr_db.getValue('fqdn'),
            "importServerSSLcert": "0",
            "KerberosConfigName": "",
            "name": gr_db.getValue('name') || '',
            "newName": gr_db.getValue('name'),
            "password": "",
            "port": gr_db.getValue('tcp_port') || '',
            "region": "",
            "savePassword": "1",
            "secretName": "",
            "serviceName": "",
            "severity": "",
            "shared": "true",
            "type": props.database_type.trim(),
            "useExternalPassword": "0",
            "useKerberos": "0",
            "useLDAP": "0",
            "user": "",
            "useSSL": "0"
        };

        // Add id if Guardium record exists and if not a request from transformCatalog
        if (ds_id && generateUniqueName) {
            ds["id"] = ds_id - 0;
            ds["name"] = gr_gdp.getValue('name'); // original name
            generateUniqueName = false;
        }

        // Build unique name
        var asName = [];
        if (ds['name']) asName.push(ds['name']);
        if (ds['host'] && !ds['name'].contains(ds['host'])) asName.push(ds['host']);
        if (ds['port'] && !ds['name'].contains(ds['port'])) asName.push(ds['port']);

        // Get database_name parameter from special class or from Guardium attributes
        if (props.database_name) {
            ds["dbName"] = gr_db.getValue(props.database_name.trim()) || '';
            if (ds['dbName'] && !ds['name'].contains(ds['dbName'])) asName.push(ds['dbName']);
        }

        // Get service_name parameter from special class or from Guardium attributes
        if (props.service_name) {
            ds["serviceName"] = gr_db.getValue(props.service_name.trim()) || '';
            if (ds['serviceName'] && !ds['name'].contains(ds['serviceName'])) asName.push(ds['serviceName']);
        }

        // Unique name
        if (generateUniqueName) {
            ds['name'] = ds['newName'] = asName.join('-');
        }

        // Return formatted JSON object
        return ds;
    },

    transformCatalog: function(gr_db, gr_dc, gr_gdp, generateUniqueName) {
        // base the Guardium datasource on the ServiceNow Database Instance
        var ds = this.transformInstance(gr_db, gr_gdp, false);
        if (!ds) return;

        // get any linked datasource record
        ds_id = gr_gdp ? gr_gdp.getValue('datasource_id') : '';

        // update Guardium datasource with ServiceNow Database Catalog values
        ds["conProperty"] = gr_dc.getValue('attributes');
        ds["customProps"] = gr_dc.getValue('running_process_key_parameters');
        ds["customURL"] = gr_dc.getValue('running_process_command');
        ds["description"] = gr_dc.getValue('description');

        if (ds_id) {
            ds["id"] = ds_id;
            ds["name"] = gr_gdp.getValue('name'); // original name
            generateUniqueName = false;
        }

        // Build a unique name
        var asName = [];
        if (ds['name']) asName.push(ds['name']);
        if (ds['port']) asName.push(ds['port']);


        // get special "Database Name" and "Service Name" fields
        var props = this.getCatalogFieldMap(ds.type);

        // Get database_name parameter from special class or from Guardium attributes
        if (props.database_name) {
            ds["dbName"] = gr_dc.getValue(props.database_name.trim()) || '';
            if (ds['dbName']) asName.push(ds['dbName']);
        }

        // Get service_name parameter from special class or from Guardium attributes
        if (props.service_name) {
            ds["serviceName"] = gr_dc.getValue(props.service_name.trim()) || '';
            if (ds['serviceName']) asName.push(ds['serviceName']);
        }

        // Unique name
        if (generateUniqueName) {
            ds['name'] = ds['newName'] = asName.join('-');
        }

        // Return formatted JSON object
        return ds;
    },

    _connectToCM: function(cm_sys_id) {
        var gAPI;
        try {
            if (!cm_sys_id) {
                // get first active CM
                var gr_cm = GuardiumAPI.getFirstActiveCM();
                if (gr_cm) {
                    cm_sys_id = gr_cm.getUniqueValue();
                }
            }
            if (!cm_sys_id) {
                GuardiumLog.error("No active Central Manager defined", this.type);
                return null;
            }
            // establish connection to the chosen CM
            gAPI = new GuardiumAPI(GuardiumAPI.getGlideRecordCM(cm_sys_id, true));
            gAPI.authenticate();
            return gAPI;
        } catch (errAuth) {
            GuardiumLog.error("Unable to authenticate" + (gAPI ? ' with ' + gAPI.cm.fqdn : ''), this.type);
            return null;
        }
    },

    getTransformProperties: function(ds_type, class_name, tcp_port) {
        var props;
        if (ds_type) {
            props = this._lookupByType[ds_type];
        }
        if (!props && GuardiumAPI.TABLE_DB != class_name) {
            props = this._lookupByClass[class_name];
        }
        if (!props || GuardiumAPI.TABLE_DB == props['database_instance_class']) {
            props = this._lookupByPort[tcp_port];
        }
        return props;
    },

    _initializeTransformCacheDI: function() {
        this._lookupByClass = {};
        this._lookupByType = {};
        this._lookupByPort = {};

        var map = this.GuardTransform.getMapDI();
        for (var ds_type in map) {
            var entry = map[ds_type];
            var class_name = entry['database_instance_class'];
            var tcp_port = entry['tcp_port'] || '';

            if (!this._lookupByClass[class_name]) this._lookupByClass[class_name] = entry;
            if (!this._lookupByType[ds_type]) this._lookupByType[ds_type] = entry;
            if (!this._lookupByPort[tcp_port]) this._lookupByPort[tcp_port] = entry;
        }
    },

    getCatalogFieldMap: function(dbType) {
        return this._catalogByType[dbType] || this._catalogByType['*'];
    },

    _initializeTransformCacheDC: function() {
        this._catalogByType = this.GuardTransform.getMapDC();
    },

    type: 'GuardiumExportDatasource'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-02-03 18:14:34</sys_created_on>
        <sys_id>fc42d9888769c910387c64280cbb3518</sys_id>
        <sys_mod_count>85</sys_mod_count>
        <sys_name>GuardiumExportDatasource</sys_name>
        <sys_package display_value="IBM Guardium Vulnerability Assessment" source="x_ibmrt_gdpva">400d30552fa0111049572f2ef699b65a</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="IBM Guardium Vulnerability Assessment">400d30552fa0111049572f2ef699b65a</sys_scope>
        <sys_update_name>sys_script_include_fc42d9888769c910387c64280cbb3518</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2022-09-08 15:04:10</sys_updated_on>
    </sys_script_include>
</record_update>
