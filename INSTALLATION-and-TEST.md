<details open="open">
  <summary><b>Table of contents</b></summary>

  - [Requirements](#requirements)
  - [Installation Instructions](#installation-instructions)
  - [SSL Certificates](#ssl-certificates)
  - [Synchronization](#synchronization)
  - [Testing](#testing)
  - [Licensing](#licensing)
  - [Contributing](/IBM/ServiceNow-Guardium-Vulnerability-Assessment/CONTRIBUTING.md)
  - [Contact us](/IBM/ServiceNow-Guardium-Vulnerability-Assessment/issues)

</details>

<hr/>

# IBM Guardium Data Protection app in ServiceNow

## Requirements

### IBM Guardium
- IBM Guardium 11.4 + Patch 441 (available in August 2022) (Patch 460 will add CVSS Attack Vector) or IBM Guardium 11.5 (with latest patch to add CVSS Attack Vector)
- IBM Guardium user with Guardium `vulnerability-access` role (or Guardium `admin` role) 
- (Optional) Add `vulnerability-access` role to all existing Guardium data sources to permit the ServiceNow plug-in the ability to update and delete existing data sources which result from changes to ServiceNow CMDB

### ServiceNow
- Tested on ServiceNow releases: Rome, San Diego, Tokyo, Utah 
- [ServiceNow Vulnerability Response](https://www.servicenow.com/products/vulnerability-response.html) module
- [ServiceNow Configuration Compliance](https://www.servicenow.com/content/dam/servicenow-assets/public/en-us/doc-type/resource-center/data-sheet/ds-security-operations.pdf) module (optional but highly recommended)

## Installation Instructions

### Create a user with "MID Server" role

- When you install the MID server, you will need a ServiceNow user and password
- After creating the user, add "MID Server" role to the user
<div style="padding-left: 2em;padding-top: 1em;">

![](images/mid-server-role.png)
</div>

### Install MID server (to be able to communicate with Guardium CM)

- Install and configure MID server to allow communication from ServiceNow to the Guardium Central Manager within your firewall

- Follow [ServiceNow instructions](https://docs.servicenow.com/bundle/sandiego-servicenow-platform/page/product/mid-server/concept/mid-server-landing.html) to add a new MID server entry in ServiceNow


### Install Vulnerability Response Module

* ServiceNow Products > Security Operations > Vulnerability Response
* Manage
* Install/Update All (4)

### Install Configuration Compliance Module

* ServiceNow Products > Security Operations > Configuration Compliance
* Manage
* Install/Update All (4)

<div style="padding-left: 2em;padding-top: 1em;">

![](images/security-operations-store.png)
</div>

### Install latest ServiceNow **Update Set** onto your non-production instance

- Download the latest [XML Update Set in GitHub](https://github.com/IBM/ServiceNow-Guardium-Vulnerability-Assessment/blob/main/Update-Sets)
- Login to your ServiceNow developer instance
- Navigate to System Update Sets > Retrieved Update Sets > Import Update Set from XML
- Browse > Select the "Update Set" XML file > Upload
- Click on the "IBM Guardium" label
- Click "Preview Update Set"
- Click "Commit Update Set"
- Click "Close"
- Verify that the IBM Guardium menu has been added to the Navigation Menu by typing "Guardium" in the navigation menu

## SSL Certificates

### Create Self-Signed Certificate

It is always best to use a certificate, signed by a certification authority, that is trusted by Java.  But if cost is an issue, use a script that can generate a self-signed certificate.

- Below is a bash script that can generate a self-signed certificate and private key valid for 10 years
- Run on any Mac, Linux, or Unix machine or [Cygwin interpreter for Windows](https://www.cygwin.com/)
- Open a command window and run the script like this: `bash ./gen-cert.sh my.fully.qualified.host.com`

```
#!/bin/bash

FQDN=$(echo ${1} | xargs)
HOSTNAME=$(echo ${FQDN} | cut -d"." -f1)
if [ "$HOSTNAME" == "" ] || [ "$HOSTNAME" == "$FQDN" ]; then
    echo "ERROR: must provide fully qualified host name like: my.host.com"
    exit 1
fi

echo "Generating certificate for: ${FQDN}"
openssl req -batch -newkey rsa:2048 -nodes -subj "/C=US/ST=MA/L=Boston/ORG=IBM/OU=Guardium/CN=${FQDN}/emailAddress=${HOSTNAME}@mailinator.com" -keyout ${HOSTNAME}.key -out ${HOSTNAME}.csr
openssl x509 -signkey ${HOSTNAME}.key -in ${HOSTNAME}.csr -req -days 3650 -out ${HOSTNAME}.crt

echo " "
echo "Private Key - for prompt: private key"
cat ${HOSTNAME}.key

echo " "
echo "Public Certificate - for prompts: End-Entity and Trusted"
cat ${HOSTNAME}.crt
```

### Replace Guardium Central Manager Certificate

- Copy and paste information echoed by the above script into this Guardium CLI command
```
store certificate gui console
```
- After completing, Guardium GUI will restart to use the new SSL certificate

### Trust Guardium Central Manager

- Java does not trust self-signed certificates by default
- You must add a self-signed certificate to the ServiceNow MID server Java keystore to build trust
- SSH onto the MID server and perform these commands, again using `my.fully.qualified.host.com` as an example:

```
# cd to mid-server agent folder
cd /path/to/mid_server/agent

# get the certificate installed on Guardium and store in a file
echo -n | openssl s_client -connect my.fully.qualified.host.com:8443 | openssl x509 > ./my-central-manager.crt

# import that public crt file into the Java keystore
keytool -import -alias "my-central-manager" -file "./my-central-manager.crt" -keystore ./jre/lib/security/cacerts
```


## Synchronization

### To begin synchronization:
- **Do this first!** Be sure the IBM Guardium SSL certificate is trusted.  [Follow instructions here](#ssl-certificates)
- You must have ServiceNow roles:  `x_ibmrt_gdpva.admin` (IBM Guardium), `agent_admin` (MID server)
- You may want ServiceNow roles: `itil`, `sn_vul.admin`, `sn_vulc.admin` 
- Create a new **IBM Guardium > Central Manager record**

<div style="padding-left: 2em;padding-top: 1em;">

![](images/configuring-central-manager.png)
</div>


## Testing

### IBM Guardium (user) Service Account
- Create a Guardium user that ServiceNow can use to communicate with Guardium over [REST-API](https://www.ibm.com/docs/en/guardium/11.5?topic=commands-guardium-api-z-reference).  The Guardium user must have role: `vulnerability-assess` or `admin`.
- You may wish to add `vulnerability-access` role to all existing Guardium data sources to allow the ServiceNow plug-in access to update and delete existing data sources

### ServiceNow Users
- The ServiceNow user you use configure IBM Guardium must have roles: `x_ibmrt_gdpva.admin` and `agent_admin` (or `admin`)
- You may also wish to add roles needed for CMDB, vulnerability Response, and Configuration Compliance modules (`sn_vul.admin`, `sn_vulc.admin`, `itil`)
- Verify you can add a Guardium central manager or stand-alone machine
- If there is more than one CM connected to ServiceNow, adjust `IBM Guardium > Database Export` rules
- Verify that Guardium data sources, data source groups, vulnerability tests, assessment tests, test results, and test exceptions are all automatically imported from Guardium into ServiceNow (may take a few hours depending on number of data sources)
- As `x_ibmrt_gdpva.admin`, verify that an assessment test can be started from ServiceNow UI
- As `x_ibmrt_gdpva.admin`, verify ServiceNow database instances and catalogs can be exported from ServiceNow to IBM Guardium
- Verify any change in ServiceNow to data source groups and test exceptions are immediately synchronized from ServiceNow to IBM Guardium

## Licensing

[Project License](/IBM/ServiceNow-Guardium-Vulnerability-Assessment/LICENSE)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
