<details open="open">
  <summary><b>Table of contents</b></summary>

  - [Requirements](#requirements)
  - [Installation Instructions](#installation-instructions)
  - [SSL Certificates](#ssl-certificates)
  - [Synchronization](#synchronization)
  - [Testing](#testing)
  - [Licensing](#licensing)
  - [Contributing](/IBM/ServiceNow-Guardium-Vulnerability-Assessment/CONTRIBUTING.md)
  - [Contact us](/IBM/ServiceNow-Guardium-Vulnerability-Assessment/issues)

</details>

<hr/>

# IBM Guardium Data Protection app in ServiceNow

## Requirements

### IBM Guardium
- IBM Guardium 11.4 + Patch 441 (available in August 2022) (Patch 460 will add CVSS Attack Vector) or IBM Guardium 11.5 (with latest patch to add CVSS Attack Vector)
- IBM Guardium user with Guardium `vulnerability-access` role (or Guardium `admin` role) 
- (Optional) Add `vulnerability-access` role to all existing Guardium data sources to permit the ServiceNow plug-in the ability to update and delete existing data sources which result from changes to ServiceNow CMDB

### ServiceNow
- Tested on ServiceNow releases: Rome, San Diego, Tokyo, Utah 
- [ServiceNow Vulnerability Response](https://www.servicenow.com/products/vulnerability-response.html) module
- [ServiceNow Vulnerability Response Integration with NVD](https://docs.servicenow.com/csh?version=latest&topicname=nvd-vuln-integration.html) module
- [ServiceNow Configuration Compliance](https://www.servicenow.com/content/dam/servicenow-assets/public/en-us/doc-type/resource-center/data-sheet/ds-security-operations.pdf) module (optional)

<br/>
<hr/>
<br/>

## Installation Instructions

- The IBM Guardium Data Protection central manager and managed units are typically installed behind a firewall
- Many companies choose to block all incoming traffic but allow outgoind traffic
- ServiceNow created the MID server application for outbound-only communication.  You install the MID server inside the firewall, within the same data center as your IBM Guardium central manager.  This allows a ServiceNow app the ability to communicate with Guardium without punching an inbound hole in your firewall.
- Do these steps in the following order:
  1. [Create a user with MID server role](#create-a-user-with-mid-server-role)
  2. [Install MID server](#install-servicenow-mid-server-to-be-able-to-communicate-with-guardium-cm)
  3. [Install ServiceNow Vulnerability Response](#install-servicenow-vulnerability-response-module)
  4. [Install ServiceNow Vulnerability Response Integration with NVD](#install-servicenow-vulnerability-response-integration-with-nvd)
  5. [(Optional) Install ServiceNow Configuration Compliance](#optional-install-servicenow-configuration-compliance-module)
  6. [Install IBM Guardium app from the ServiceNow store](#install-servicenow-certified-store-app) or [from Update Set](#install-servicenow-update-set-onto-your-non-production-instance)
  7. [Install SSL certificate](#ssl-certificates) on your Guardium central manager, if necessary
  8. [Trust the Guardium central manager SSL certificate](#trust-guardium-central-manager)
  9. [Set ServiceNow system-wide timeout]

<br/>

### Create a user with "MID Server" role
- When you install the MID server, you will need a ServiceNow user and password[]
- After creating the user, add "mid_server" role to the user
<div style="padding-left: 2em;padding-top: 1em;">

![](images/mid-server-role.png)
</div>
<br/>

### Install ServiceNow MID server (to be able to communicate with Guardium CM)
- Install and configure MID server to allow communication from ServiceNow to the Guardium Central Manager within your firewall
- [ServiceNow MID server](https://docs.servicenow.com/csh?version=latest&topicname=mid-server-landing.html) overview
- [ServiceNow MID server](https://docs.servicenow.com/csh?version=latest&topicname=mid-server-installation.html) installation
- [ServiceNow MID server certificate](https://docs.servicenow.com/csh?version=latest&topicname=add-ssl-certificates.html) import

<br/>


### Install ServiceNow Vulnerability Response module
- [ServiceNow > Security Operations > Vulnerability Response](https://store.servicenow.com/sn_appstore_store.do#!/store/product/d19b5320db84fb004bd8596e5e9619db)
- System Applications > ServiceNow Products > Security Operations > Vulnerability Response
- Manage
- Install/Update All (4)

<br/>

### Install ServiceNow Vulnerability Response Integration with NVD
- System Applications > All Available Applications > All
- Search for "NVD"
- Install "Vulnerability Response Integration with NVD"

<div style="padding-left: 2em;padding-top: 1em;">

![](images/vr-nvd-integration.png)
<br/>
<br/>
![](images/vr-nvd-run.png)
</div>
<br/>


### (Optional) Install ServiceNow Configuration Compliance module
- [ServiceNow > Security Operations > Configuration Compliance](https://store.servicenow.com/sn_appstore_store.do#!/store/product/a8436513db047300474178b5ae9619e5)
- System Applications > ServiceNow Products > Security Operations > Configuration Compliance
- Manage
- Install/Update All (4)


<div style="padding-left: 2em;padding-top: 1em;">

![](images/security-operations-store.png)
</div>
<br/>


### Install IBM Guardium Integration
- Choose one, not both!
  * The [certified app](#install-servicenow-certified-store-app) in the ServiceNow store
  * The [published Update Set](#install-servicenow-update-set-onto-your-non-production-instance)

<br/>

#### Install ServiceNow certified store app
- [ServiceNow IBM Guardium App](https://store.servicenow.com/sn_appstore_store.do#!/store/application/400d30552fa0111049572f2ef699b65a)
- This is free to install on your paid ServiceNow instance
  * Go to System Applications > All Available Applications > All
  * Search for Guardium
  * Click **Install**
- If installing on a personal developer instance
  * Go to System Applications > All Available Applications > Available To Obtain From Store
  * Search for Guardium
  * Click **Request install**
  * An notification will be sent to IBM, IBM will approve your PDI, and you will be able to install on your PDI

#### Install ServiceNow **Update Set** onto your non-production instance

- **ONLY DO THIS IF NOT INSTALLING THE CERTIFIED APP ABOVE !!**
- Download the latest [XML Update Set in GitHub](https://github.com/IBM/ServiceNow-Guardium-Vulnerability-Assessment/blob/main/Update-Sets)
- Login to your ServiceNow personal developer instance
- Navigate to System Update Sets > Retrieved Update Sets > Import Update Set from XML
- Browse > Select the "Update Set" XML file > Upload
- Click on the "IBM Guardium" label
- Click "Preview Update Set"
- Click "Commit Update Set"
- Click "Close"
- Verify that the IBM Guardium menu has been added to the Navigation Menu by typing "Guardium" in the navigation menu

<br/>

## SSL Certificates

### Create Self-Signed Certificate

It is always best to use a certificate, signed by a certification authority, that is trusted by Java.  But if cost is an issue, use a script that can generate a self-signed certificate.

- Below is a bash script that can generate a self-signed certificate and private key valid for 10 years.  Change the `-subj` to suit your needs.
- Run on any Mac, Linux, or Unix machine or [Cygwin interpreter for Windows](https://www.cygwin.com/)
- Open a command window and run the script like this (use your central manager host value): `bash ./gen-cert.sh my.central.manager.com`

```
#!/bin/bash

FQDN=$(echo ${1} | xargs)
HOSTNAME=$(echo ${FQDN} | cut -d"." -f1)
if [ "$HOSTNAME" == "" ] || [ "$HOSTNAME" == "$FQDN" ]; then
    echo "ERROR: must provide fully qualified host name like: my.host.com"
    exit 1
fi

echo "Generating certificate for: ${FQDN}"
openssl req -batch -newkey rsa:2048 -nodes -subj "/C=US/ST=MA/L=Boston/ORG=IBM/OU=Guardium/CN=${FQDN}/emailAddress=${HOSTNAME}@mailinator.com" -keyout ${HOSTNAME}.key -out ${HOSTNAME}.csr
openssl x509 -signkey ${HOSTNAME}.key -in ${HOSTNAME}.csr -req -days 3650 -out ${HOSTNAME}.crt

echo " "
echo "Private Key - for prompt: private key"
cat ${HOSTNAME}.key

echo " "
echo "Public Certificate - for prompts: End-Entity and Trusted"
cat ${HOSTNAME}.crt
```

### Replace Guardium Central Manager Certificate

- Copy and paste information echoed by the above script into this Guardium CLI command
```
store certificate gui console
```
- After completing, Guardium GUI will restart to use the new SSL certificate

### Trust Guardium Central Manager

- Java does not trust self-signed certificates by default
- You must add a self-signed certificate to the ServiceNow MID server Java keystore to build trust
- SSH onto the MID server and perform these commands, again using `my.central.manager.com` as an example:

```
# cd to mid-server agent folder
cd /path/to/mid_server/agent

# get the certificate installed on Guardium and store in a file
echo -n | openssl s_client -connect my.central.manager.com:8443 | openssl x509 > ./my-central-manager.crt

# import that public crt file into the Java keystore
keytool -import -alias "my-central-manager" -file "./my-central-manager.crt" -keystore ./jre/lib/security/cacerts
```

<br/>

## Set ServiceNow System-wide Properties
- glide.http.outbound.max_timeout=60
- glide.http.outbound.max_timeout.enabled=true

<div style="padding-left: 2em;padding-top: 1em;">

![](images/sys-properties.png)
</div>
<br/>

## Synchronization

### To begin synchronization:
- **Do this first!** Be sure the IBM Guardium SSL certificate is trusted.  [Follow instructions here](#ssl-certificates)
- You must have ServiceNow roles:  `x_ibmrt_gdpva.admin` (IBM Guardium), `agent_admin` (MID server)
- You may want ServiceNow roles: `itil`, `sn_vul.admin`, `sn_vulc.admin` 
- Create a new **IBM Guardium > Central Manager** record - Fill in name, host, client ID, client secret, user, password, MID server fields
- Open **IBM Guardium > Integrations > Daily Import** - Click **Execute Now**

<div style="padding-left: 2em;padding-top: 1em;">

![](images/configuring-central-manager.png)
</div>
<br/>


## Testing

### IBM Guardium (user) Service Account
- Create a Guardium user that ServiceNow can use to communicate with Guardium over [REST-API](https://www.ibm.com/docs/en/guardium/11.5?topic=commands-guardium-api-z-reference).  The Guardium user must have role: `vulnerability-assess` or `admin`.
- You may wish to add `vulnerability-access` role to all existing Guardium data sources to allow the ServiceNow plug-in access to update and delete existing data sources

### ServiceNow Users
- The ServiceNow user you use configure IBM Guardium must have roles: `x_ibmrt_gdpva.admin` and `agent_admin` (or `admin`)
- You may also wish to add roles needed for CMDB, vulnerability Response, and Configuration Compliance modules (`sn_vul.admin`, `sn_vulc.admin`, `itil`)
- Verify ServiceNow can communicate with a Guardium central manager or stand-alone machine by examining the **IBM Guardium > Application Log**
- Verify that Guardium data sources, vulnerability tests, and test results are all imported from Guardium into ServiceNow (may take a few hours depending on number of test results -- you can minimize the number of days imported from **IBM Guardium > Settings**)
- As `x_ibmrt_gdpva.admin`, verify that an assessment test can be started from ServiceNow UI

<br/>

## Licensing

[Project License](/IBM/ServiceNow-Guardium-Vulnerability-Assessment/LICENSE)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
